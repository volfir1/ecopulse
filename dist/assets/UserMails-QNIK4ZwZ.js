import{r as o,b as I,V as S,j as e,B as a,L as A,T as n,$ as m,Y as i,a5 as L,q as N,E as W}from"./index-D-CDyacC.js";import{t as B}from"./ticketService-BUEzRzQk.js";import{g as E,a as F,f as z}from"./userTicketUtils-pc0UEb49.js";import{T as D,a as U}from"./Tabs-Crx7z2dm.js";import{G as v}from"./Grid-Bn1cnVmp.js";import{C as g}from"./Chip-datRF1Xi.js";import"./axios-CmsuhreG.js";import"./index-KbUEj7NM.js";import"./typeof-QjJsDpFa.js";import"./KeyboardArrowRight-DEGN5Fl8.js";const H=()=>{const[p,l]=o.useState([]),[C,j]=o.useState(!0),[c,y]=o.useState(null),[d,w]=o.useState(0),[x,T]=o.useState(""),u=I();o.useContext(S);const h=["All","Open","In Progress","Resolved","Closed"];o.useEffect(()=>{(async()=>{j(!0);try{console.log("Fetching user tickets...");const s=await B.getUserTickets();if(console.log("Full API response:",s),s.success){const r=s.data;console.log("Ticket data to be set:",r),Array.isArray(r)?l(r):r&&Array.isArray(r.data)?l(r.data):(console.warn("Unexpected data structure:",r),l([]))}else y(s.message||"Failed to load tickets"),l([])}catch(s){console.error("Error fetching tickets:",s),y(s.message||"Error loading tickets"),l([])}finally{j(!1)}})()},[]);const f=()=>{let t=[...p];if(console.log("Filtering tickets. Total before filter:",p.length),d>0){const s=h[d].toLowerCase().replace(" ","-");t=t.filter(r=>r.status===s),console.log(`Filtered by status '${s}':`,t.length)}if(x){const s=x.toLowerCase();t=t.filter(r=>r.subject&&r.subject.toLowerCase().includes(s)||r.ticketNumber&&r.ticketNumber.toString().includes(s)||r.category&&r.category.toLowerCase().includes(s)),console.log(`Filtered by search '${s}':`,t.length)}return t},k=t=>{u(`/mails/${t}`)};return C?e.jsx(a,{sx:{display:"flex",justifyContent:"center",alignItems:"center",height:"calc(100vh - 200px)"},children:e.jsx(A,{})}):e.jsxs(a,{sx:{width:"100%",p:3},children:[e.jsxs(a,{sx:{mb:4,display:"flex",justifyContent:"space-between",alignItems:"center",flexWrap:"wrap",gap:2},children:[e.jsx(n,{variant:"h4",fontWeight:"bold",children:"My Support Tickets"}),e.jsx(m,{variant:"contained",color:"primary",startIcon:e.jsx(i,{name:"plus"}),onClick:()=>u("/help-support"),children:"New Ticket"})]}),e.jsxs(a,{sx:{mb:2,p:2,border:"1px dashed #ccc",display:"none"},children:[e.jsxs(n,{variant:"caption",component:"div",children:["Debug: ",p.length," total tickets"]}),e.jsxs(n,{variant:"caption",component:"div",children:["Auth Token: ",localStorage.getItem("authToken")?"✓ Present":"✗ Missing"]})]}),e.jsxs(a,{sx:{mb:3,display:"flex",flexDirection:{xs:"column",md:"row"},gap:2,alignItems:{md:"center"}},children:[e.jsx(a,{sx:{width:{xs:"100%",md:"300px"}},children:e.jsx(L,{placeholder:"Search tickets...",value:x,onChange:t=>T(t.target.value),fullWidth:!0})}),e.jsx(D,{value:d,onChange:(t,s)=>w(s),sx:{borderBottom:1,borderColor:"divider",minHeight:48,".MuiTabs-flexContainer":{flexWrap:"wrap"}},children:h.map((t,s)=>e.jsx(U,{label:t},s))})]}),c?e.jsxs(a,{sx:{textAlign:"center",py:4},children:[e.jsx(i,{name:"alert-triangle",size:40,color:"error"}),e.jsx(n,{color:"error",variant:"h6",mt:2,children:c}),e.jsx(n,{variant:"body2",color:"text.secondary",mt:1,children:c!=null&&c.includes("auth")?"Authentication error. Please try logging in again.":""}),e.jsx(m,{variant:"outlined",onClick:()=>window.location.reload(),startIcon:e.jsx(i,{name:"refresh-cw"}),sx:{mt:2},children:"Retry"})]}):f().length===0?e.jsxs(a,{sx:{textAlign:"center",py:4},children:[e.jsx(i,{name:"inbox",size:40}),e.jsx(n,{variant:"h6",mt:2,children:"No tickets found"}),e.jsx(n,{variant:"body1",color:"text.secondary",mt:1,children:x?"Try adjusting your search criteria":d>0?`You don't have any ${h[d].toLowerCase()} tickets`:"You haven't submitted any support tickets yet"}),e.jsx(m,{variant:"contained",onClick:()=>u("/help-support"),startIcon:e.jsx(i,{name:"plus"}),sx:{mt:3},children:"Submit New Ticket"})]}):e.jsx(v,{container:!0,spacing:2,children:f().map(t=>{var b;const s=E(t.status),r=F(t.status);return e.jsx(v,{item:!0,xs:12,children:e.jsx(N.Base,{variant:s,elevation:1,sx:{cursor:"pointer","&:hover":{transform:"translateY(-2px)",boxShadow:3}},onClick:()=>k(t._id),children:e.jsxs(a,{sx:{p:2},children:[e.jsxs(a,{display:"flex",justifyContent:"space-between",alignItems:"center",mb:1,children:[e.jsxs(a,{display:"flex",alignItems:"center",gap:1,children:[e.jsx(i,{name:r,size:18}),e.jsx(n,{variant:"h6",fontWeight:"medium",children:t.subject||"No Subject"})]}),e.jsx(g,{label:(t.status||"unknown").toUpperCase().replace("-"," "),color:s,size:"small"})]}),e.jsx(n,{variant:"body2",color:"text.secondary",sx:{overflow:"hidden",textOverflow:"ellipsis",display:"-webkit-box",WebkitLineClamp:2,WebkitBoxOrient:"vertical",mb:2},children:t.messages&&((b=t.messages[0])==null?void 0:b.content)||"No description available"}),e.jsx(W,{sx:{mb:2}}),e.jsxs(a,{display:"flex",justifyContent:"space-between",alignItems:"center",flexWrap:"wrap",gap:1,children:[e.jsxs(a,{display:"flex",alignItems:"center",gap:1,children:[e.jsxs(n,{variant:"caption",color:"text.secondary",children:[e.jsx("b",{children:"Ticket ID:"})," #",t.ticketNumber||"------"]}),t.category&&e.jsx(g,{label:t.category.toUpperCase(),size:"small",variant:"outlined"}),t.priority&&e.jsx(g,{label:t.priority.toUpperCase(),size:"small",color:t.priority==="high"||t.priority==="urgent"?"error":t.priority==="medium"?"warning":"success",variant:"outlined"})]}),e.jsx(n,{variant:"caption",color:"text.secondary",children:z(t.updatedAt)})]})]})})},t._id)})})]})};export{H as default};
