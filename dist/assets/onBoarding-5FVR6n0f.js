import{b as _,e as q,l as Y,u as M,r as c,R as V,j as e,p as y,U as W,t as k,s as H,v as Q,w as K,x as X}from"./index-CeiZKB8G.js";import{A as Z}from"./arrow-right-BnEHM_lN.js";const F=[{id:"avatar-1",src:"/avatars/1.svg",alt:"Avatar 1"},{id:"avatar-2",src:"/avatars/2.svg",alt:"Avatar 2"},{id:"avatar-3",src:"/avatars/3.svg",alt:"Avatar 3"},{id:"avatar-4",src:"/avatars/4.svg",alt:"Avatar 4"},{id:"avatar-5",src:"/avatars/5.svg",alt:"Avatar 5"},{id:"avatar-6",src:"/avatars/6.svg",alt:"Avatar 6"},{id:"default-avatar",src:" /avatars/7.svg",alt:"Default Avatar"}],ee=[{value:"male",label:"Male"},{value:"female",label:"Female"},{value:"non-binary",label:"Non-binary"},{value:"transgender",label:"Transgender"},{value:"other",label:"Other"},{value:"prefer-not-to-say",label:"Prefer not to say"}],se=()=>{const w=_(),o=q(),{startLoading:R,stopLoading:L,isLoading:j}=Y(),{user:a,setUser:h}=M(),[g,U]=c.useState("prefer-not-to-say"),[N,O]=c.useState("default-avatar"),[f,S]=c.useState(!1),[$,m]=c.useState(0),[C,E]=c.useState(!1),[v,T]=c.useState(""),p=V.useRef(null);c.useEffect(()=>{var l;const t=localStorage.getItem("authToken"),r=localStorage.getItem("user");if(!t||!r){console.error("Missing authentication in onboarding"),o.error("Authentication error. Please try logging in again."),w("/login");return}console.log("Onboarding auth check:",{hasToken:!!t,hasUser:!!r,userId:(a==null?void 0:a.id)||((l=JSON.parse(r))==null?void 0:l.id)})},[]),c.useEffect(()=>{a&&(a.gender&&U(a.gender),a.avatar&&(a.avatar.includes("cloudinary.com")?(S(!0),T(a.avatar)):O(a.avatar)))},[a]);const D=()=>{var t;(t=p.current)==null||t.click()},z=async t=>{var r;try{const l=F.find(b=>b.id===t);if(!l)throw new Error("Selected avatar not found");let i=l.src;i.startsWith("/")&&(i=`${window.location.origin}${i}`),console.log("Fetching SVG from:",i);const n=await fetch(i);if(!n.ok)throw new Error(`Failed to fetch SVG: ${n.status}`);const d=await n.text(),A=`data:image/svg+xml;base64,${btoa(d)}`,s=await X(A,{maxSizeMB:2,maxWidthOrHeight:800,quality:.9}),I=`${(a==null?void 0:a.id)||((r=JSON.parse(localStorage.getItem("user")))==null?void 0:r.id)}_${Date.now()}`,x=await fetch("http://localhost:5000/api/upload/avatar/base64",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("authToken")}`},body:JSON.stringify({base64Image:s,avatarId:t,uniqueId:I})});if(!x.ok){const b=await x.json();throw new Error(b.message||`Server error: ${x.status}`)}const P=await x.json();if(!P.success)throw new Error(P.message||"Failed to upload default avatar");return P.avatar}catch(l){throw console.error("Error uploading default avatar:",l),l}},B=async t=>{var i;const r=(i=t.target.files)==null?void 0:i[0];if(!r)return;if(!["image/jpeg","image/png","image/gif","image/jpg"].includes(r.type)){o.error("Please select a valid image file (JPEG, PNG, GIF)");return}E(!0),m(10);try{r.size>2*1024*1024&&o.info("Compressing image for optimal upload...",{autoClose:2e3}),m(20);const n=await K(r,{maxSizeMB:2,maxWidthOrHeight:800,initialQuality:.8});m(40);const d=new FormData;d.append("avatar",n);const s=await fetch("http://localhost:5000/api/upload/avatar",{method:"POST",headers:{Authorization:`Bearer ${localStorage.getItem("authToken")}`},body:d});if(m(70),!s.ok){const I=await s.json();throw new Error(I.message||`Server error: ${s.status}`)}const u=await s.json();if(!u.success)throw new Error(u.message||"Failed to upload image");if(console.log("Avatar upload response:",u),!u.avatar)throw new Error("No avatar URL returned from server");T(u.avatar),S(!0),m(100),o.success("Avatar uploaded successfully!"),h&&a&&h({...a,avatar:u.avatar})}catch(n){console.error("Error uploading avatar:",n),n.message&&n.message.includes("entity too large")?o.error("Image is too large. Please try a smaller image or use one of our default avatars."):o.error(n.message||"Failed to upload avatar")}finally{E(!1),p.current&&(p.current.value="")}},G=async()=>{var t;R();try{let r;if(f&&v)r=v;else try{o.info("Processing avatar...",{autoClose:2e3}),r=await z(N)}catch(s){console.error("Failed to upload default avatar:",s),s.message&&s.message.includes("entity too large")?o.error("Avatar image is too large. Using a simplified version instead."):o.warning("Using default avatar due to upload issue",{autoClose:2e3}),r=N}console.log("Final avatar being saved:",r);const l=(a==null?void 0:a.id)||((t=JSON.parse(localStorage.getItem("user")))==null?void 0:t.id),i="http://localhost:5000/api",n=JSON.stringify({gender:g,avatar:r,hasCompletedOnboarding:!0}).length;console.log("Onboarding update request:",{userId:l,gender:g,avatarLength:r.length,hasCompletedOnboarding:!0});const d=await fetch(`${i}/users/onboarding`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("authToken")}`},body:JSON.stringify({gender:g,avatar:r,hasCompletedOnboarding:!0}),credentials:"include"});if(!d.ok){const s=await d.json();throw new Error(s.message||`Server error: ${d.status}`)}const A=await d.json();if(h&&a){const s={...a,gender:g,avatar:r,hasCompletedOnboarding:!0};h(s),localStorage.setItem("user",JSON.stringify(s))}o.success("Profile updated successfully!"),setTimeout(()=>{w((a==null?void 0:a.role)==="admin"?"/admin/dashboard":"/dashboard")},800)}catch(r){console.error("Profile update error:",r),r.message&&r.message.includes("entity too large")?o.error("Profile update failed due to image size. Please try a smaller avatar image."):o.error(r.message||"Failed to update profile. Please try again.")}finally{L()}},J=()=>{o.info("You can update your profile later in the settings."),w((a==null?void 0:a.role)==="admin"?"/admin/dashboard":"/dashboard")};return e.jsx("div",{className:"min-h-screen bg-gray-50 flex flex-col items-center justify-center p-6",children:e.jsxs("div",{className:"w-full max-w-2xl bg-white rounded-2xl shadow-lg p-8",children:[e.jsxs("div",{className:"text-center mb-8",children:[e.jsx("div",{className:"flex justify-center mb-4",children:e.jsx("div",{className:"w-20 h-20 rounded-full flex items-center justify-center",style:{border:`2px solid ${y.main}`},children:e.jsx(W,{className:"w-10 h-10",style:{color:y.main}})})}),e.jsx("h1",{className:"text-3xl font-bold mb-2",style:{color:k.main},children:"Complete Your Profile"}),e.jsx("p",{className:"text-gray-600 text-lg max-w-lg mx-auto",children:"Personalize your EcoPulse experience by setting up your profile. This helps us provide a more tailored experience."})]}),e.jsxs("div",{className:"mb-8",children:[e.jsx("h2",{className:"font-semibold text-xl mb-4",style:{color:k.main},children:"Choose Your Gender"}),e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-3 gap-3",children:ee.map(t=>e.jsx("button",{type:"button",className:`py-4 px-3 rounded-xl border-2 transition-all ${g===t.value?"border-green-600 bg-green-50 shadow-md":"border-gray-200 hover:border-gray-300 hover:bg-gray-50"}`,onClick:()=>U(t.value),children:e.jsxs("div",{className:"flex items-center",children:[g===t.value&&e.jsx(H,{className:"w-5 h-5 text-green-600 mr-2"}),e.jsx("span",{className:`${g===t.value?"font-medium":""}`,children:t.label})]})},t.value))})]}),e.jsxs("div",{className:"mb-10",children:[e.jsx("h2",{className:"font-semibold text-xl mb-4",style:{color:k.main},children:"Choose Your Avatar"}),e.jsxs("div",{className:"grid grid-cols-4 gap-4",children:[F.map(t=>e.jsx("button",{type:"button",className:`p-3 rounded-xl border-2 transition-all ${!f&&N===t.id?"border-green-600 bg-green-50 shadow-md":"border-gray-200 hover:border-gray-300 hover:bg-gray-50"}`,onClick:()=>{O(t.id),S(!1)},children:e.jsx("img",{src:t.src,alt:t.alt,className:"w-full h-auto rounded-lg"})},t.id)),e.jsx("button",{type:"button",className:`p-3 rounded-xl border-2 transition-all ${f?"border-green-600 bg-green-50 shadow-md":"border-gray-200 hover:border-gray-300 hover:bg-gray-50"}`,onClick:D,children:f&&v?e.jsx("img",{src:v,alt:"Custom Avatar",className:"w-full h-auto aspect-square object-cover rounded-lg"}):e.jsxs("div",{className:"flex flex-col items-center justify-center h-full aspect-square bg-gray-100 rounded-lg",children:[e.jsx(Q,{className:"w-8 h-8 mb-2 text-gray-400"}),e.jsx("span",{className:"text-xs text-gray-500",children:"Upload"})]})}),e.jsx("input",{type:"file",ref:p,className:"hidden",accept:"image/jpeg, image/png, image/gif",onChange:B})]}),C&&e.jsxs("div",{className:"mt-4",children:[e.jsx("div",{className:"w-full bg-gray-200 rounded-full h-2.5",children:e.jsx("div",{className:"bg-green-600 h-2.5 rounded-full",style:{width:`${$}%`}})}),e.jsxs("p",{className:"text-sm text-gray-500 text-center mt-2",children:["Uploading... ",$,"%"]})]}),e.jsx("p",{className:"text-sm text-gray-500 mt-4 text-center",children:"You can change your avatar anytime from your profile settings."})]}),e.jsxs("div",{className:"flex flex-col space-y-3",children:[e.jsx("button",{type:"button",onClick:G,disabled:j||C,className:"w-full py-3 flex items-center justify-center bg-green-600 text-white rounded-xl font-medium hover:bg-green-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed",style:{backgroundColor:y.main,borderColor:y.main},children:j?"Saving...":e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"text-lg",children:"Complete & Continue"}),e.jsx(Z,{className:"w-5 h-5 ml-2"})]})}),e.jsx("button",{type:"button",onClick:J,disabled:j||C,className:"w-full py-2 text-gray-600 hover:text-gray-800 transition-colors text-sm",children:"Skip for now"})]})]})})};export{se as default};
