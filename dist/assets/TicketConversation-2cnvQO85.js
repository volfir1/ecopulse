import{r as x,e as B,V as W,a6 as $,P as U,B as a,a7 as E,j as e,L as M,Y as c,T as o,$ as j,q as D,D as F,a1 as A,a8 as P}from"./index-BN0NLy4X.js";import{t as b}from"./ticketService-BUEzRzQk.js";import{g as L,a as q,b as G,c as _,f as I,d as R,i as H,e as Y}from"./userTicketUtils-Dvip4-2p.js";import{C as N}from"./Chip-BQdj-Ugh.js";import"./axios-CmsuhreG.js";import"./typeof-QjJsDpFa.js";const V=r=>{const[l,s]=x.useState(null),[C,u]=x.useState(!0),[k,y]=x.useState(null),[g,v]=x.useState(""),{showSnackbar:i}=B(),{user:h}=x.useContext(W),p=x.useCallback(async()=>{if(!r){y("Invalid ticket ID"),u(!1);return}u(!0);try{console.log(`Fetching ticket conversation for ticket ID: ${r}`);const t=await b.getTicket(r);if(console.log("Ticket API response:",t),t.success){const n=t.data;console.log("Ticket data to be set:",n),s(n)}else{const n=t.message||"Failed to load ticket details";console.error(n),y(n),i(n,"error")}}catch(t){console.error("Error fetching ticket:",t);const n=t.message||"Error loading ticket";y(n),i(n,"error")}finally{u(!1)}},[r,i]),T=async()=>{if(!g.trim()){i("Reply content cannot be empty","warning");return}try{console.log(`Sending reply to ticket ${r}:`,g);const t=await b.replyToTicket(r,g);t.success?(s(t.data),v(""),i("Reply sent successfully","success")):i(t.message||"Failed to send reply","error")}catch(t){console.error("Error sending reply:",t),i(t.message||"Failed to send reply","error")}},w=async()=>{try{console.log(`Marking ticket ${r} as resolved`);const t=await b.updateTicketStatus(r,"resolved");t.success?(s(t.data),i("Ticket marked as resolved","success")):i(t.message||"Failed to update ticket status","error")}catch(t){console.error("Error updating ticket status:",t),i(t.message||"Failed to update ticket status","error")}},S=async t=>{if(!h||h.role!=="admin"){i("Not authorized to update ticket status","error");return}try{console.log(`Updating ticket ${r} status to ${t}`);const n=await b.updateTicketStatus(r,t);n.success?(s(n.data),i(`Ticket ${t} successfully`,"success")):i(n.message||"Failed to update ticket status","error")}catch(n){console.error("Error updating ticket status:",n),i(n.message||"Failed to update ticket status","error")}};return x.useEffect(()=>{p()},[p]),{ticket:l,loading:C,error:k,replyContent:g,setReplyContent:v,sendReply:T,markAsResolved:w,updateTicketStatus:S,refreshTicket:p}},J=$(U)(({theme:r,isCurrentUser:l,isAdmin:s})=>({padding:r.spacing(2),marginBottom:r.spacing(2),maxWidth:"80%",borderRadius:r.spacing(1.5),position:"relative",...l?{backgroundColor:r.palette.primary.light,color:r.palette.primary.contrastText,alignSelf:"flex-end"}:s?{backgroundColor:r.palette.secondary.light,color:r.palette.secondary.contrastText,alignSelf:"flex-start"}:{backgroundColor:r.palette.background.default,alignSelf:"flex-start"}})),K=$(a)({display:"flex",flexDirection:"column",gap:"8px",marginBottom:"16px"}),O=$(a)(({theme:r})=>({display:"flex",flexDirection:"column",gap:r.spacing(2),padding:r.spacing(2),borderTop:`1px solid ${r.palette.divider}`})),re=()=>{const{ticketId:r}=E(),{user:l}=x.useContext(W),{ticket:s,loading:C,error:u,replyContent:k,setReplyContent:y,sendReply:g,markAsResolved:v,updateTicketStatus:i}=V(r);if(C)return e.jsx(a,{sx:{display:"flex",justifyContent:"center",alignItems:"center",height:"calc(100vh - 200px)"},children:e.jsx(M,{})});if(u)return e.jsxs(a,{sx:{display:"flex",flexDirection:"column",justifyContent:"center",alignItems:"center",height:"calc(100vh - 200px)",gap:2},children:[e.jsx(c,{name:"alert-triangle",size:40,color:"error"}),e.jsx(o,{color:"error",variant:"h6",children:u}),e.jsx(j,{variant:"outlined",onClick:()=>window.history.back(),startIcon:e.jsx(c,{name:"arrow-left"}),children:"Go Back"})]});if(!s)return e.jsxs(a,{sx:{display:"flex",flexDirection:"column",justifyContent:"center",alignItems:"center",height:"calc(100vh - 200px)",gap:2},children:[e.jsx(c,{name:"file-question",size:40}),e.jsx(o,{variant:"h6",children:"Ticket not found"}),e.jsx(j,{variant:"outlined",onClick:()=>window.history.back(),startIcon:e.jsx(c,{name:"arrow-left"}),children:"Go Back"})]});const h=(l==null?void 0:l.role)==="admin",p=L(s.status),T=q(s.status),{color:w}=G(s.priority||"medium"),S=_(s.ticketNumber),t=l&&!h&&s.status==="in-progress",n=l&&["open","in-progress"].includes(s.status);return e.jsxs(a,{sx:{width:"100%",maxWidth:900,mx:"auto",py:3,px:2},children:[e.jsx(D.Base,{variant:p,elevation:3,sx:{mb:3},children:e.jsxs(a,{sx:{p:2},children:[e.jsxs(a,{display:"flex",alignItems:"center",justifyContent:"space-between",mb:2,flexWrap:"wrap",gap:1,children:[e.jsxs(a,{display:"flex",alignItems:"center",gap:1,children:[e.jsx(c,{name:T,size:20}),e.jsxs(o,{variant:"h6",fontWeight:"bold",children:[S,": ",s.subject]})]}),e.jsx(N,{label:s.status.toUpperCase(),color:p,size:"small"})]}),e.jsx(F,{sx:{my:2}}),e.jsxs(a,{display:"flex",flexWrap:"wrap",gap:3,justifyContent:"space-between",children:[e.jsxs(a,{minWidth:"120px",children:[e.jsx(o,{variant:"body2",color:"text.secondary",children:"Category"}),e.jsx(o,{variant:"body1",children:s.category||"General"})]}),e.jsxs(a,{minWidth:"120px",children:[e.jsx(o,{variant:"body2",color:"text.secondary",children:"Priority"}),e.jsx(N,{label:(s.priority||"Medium").toUpperCase(),color:w,size:"small"})]}),e.jsxs(a,{minWidth:"150px",children:[e.jsx(o,{variant:"body2",color:"text.secondary",children:"Created"}),e.jsx(o,{variant:"body1",children:I(s.createdAt)})]}),e.jsxs(a,{minWidth:"150px",children:[e.jsx(o,{variant:"body2",color:"text.secondary",children:"Last Updated"}),e.jsx(o,{variant:"body1",children:I(s.updatedAt)})]})]}),h&&s.assignedTo&&e.jsxs(a,{mt:2,children:[e.jsx(o,{variant:"body2",color:"text.secondary",children:"Assigned To"}),e.jsxs(a,{display:"flex",alignItems:"center",gap:1,children:[e.jsx(A,{sx:{width:24,height:24},children:R(`${s.assignedTo.firstName||""} ${s.assignedTo.lastName||""}`)}),e.jsxs(o,{children:[s.assignedTo.firstName," ",s.assignedTo.lastName]})]})]})]})}),e.jsx(D.Base,{elevation:2,sx:{mb:3},children:e.jsxs(a,{sx:{p:2},children:[e.jsx(o,{variant:"h6",mb:2,children:"Conversation"}),e.jsx(a,{sx:{display:"flex",flexDirection:"column",gap:3,height:"400px",maxHeight:"50vh",overflowY:"auto",p:1},children:s.messages&&s.messages.length>0?s.messages.map((d,z)=>{const f=H(d,l==null?void 0:l._id);let m="Unknown User";return f?m=`${l.firstName} ${l.lastName}`:d.isAdmin?m="Support Agent":s.user&&(m=`${s.user.firstName||""} ${s.user.lastName||""}`.trim()||"User"),e.jsxs(K,{children:[e.jsxs(a,{display:"flex",alignItems:"center",justifyContent:f?"flex-end":"flex-start",gap:1,mb:1,children:[!f&&e.jsx(A,{sx:{width:32,height:32},children:R(m)}),e.jsxs(o,{variant:"body2",color:"text.secondary",children:[m," â€¢ ",I(d.createdAt)]}),d.isAdmin&&e.jsx(N,{label:"Staff",size:"small",color:"secondary"}),f&&e.jsx(A,{sx:{width:32,height:32},children:R(m)})]}),e.jsx(J,{isCurrentUser:f,isAdmin:d.isAdmin,elevation:1,children:e.jsx(o,{variant:"body1",dangerouslySetInnerHTML:{__html:Y(d.content)}})})]},z)}):e.jsxs(a,{sx:{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",height:"100%",opacity:.7},children:[e.jsx(c,{name:"message-square",size:40}),e.jsx(o,{variant:"body1",mt:1,children:"No messages yet"})]})}),n&&e.jsxs(O,{children:[e.jsx(P,{rows:4,placeholder:"Type your reply here...",value:k,onChange:d=>y(d.target.value),fullWidth:!0,variant:"outlined"}),e.jsxs(a,{display:"flex",justifyContent:"space-between",alignItems:"center",flexWrap:"wrap",gap:2,children:[t&&e.jsx(j,{variant:"outlined",color:"success",startIcon:e.jsx(c,{name:"check-circle"}),onClick:v,children:"Mark as Resolved"}),e.jsx(a,{ml:"auto",children:e.jsx(j,{variant:"contained",color:"primary",startIcon:e.jsx(c,{name:"send"}),onClick:g,disabled:!k.trim(),children:"Send Reply"})})]})]}),!n&&e.jsxs(a,{textAlign:"center",p:3,bgcolor:"background.paper",borderRadius:1,border:1,borderColor:"divider",children:[e.jsx(c,{name:s.status==="closed"?"lock":"check-circle",size:32,color:p}),e.jsxs(o,{variant:"h6",color:"text.secondary",mt:1,children:["This ticket is ",s.status==="closed"?"closed":"resolved"]}),s.status==="resolved"&&h&&e.jsx(j,{variant:"outlined",color:"primary",size:"small",startIcon:e.jsx(c,{name:"lock"}),onClick:()=>i("closed"),sx:{mt:2},children:"Close Ticket"})]})]})})]})};export{re as default};
