import{u as re,b as te,e as X,r as b,f as se,a0 as oe,j as e,L as ne,B as m,T as S,P as z,a1 as Q,E as ie,a as B,Y as le,a2 as de,a3 as Z,s as ce,a4 as ue}from"./index-D-CDyacC.js";import{u as L}from"./userService-C-OnijlG.js";import{u as he}from"./index-ENk1B4-s.js";import{C as _}from"./Container-CGi0RHh_.js";import{G as p}from"./Grid-Bn1cnVmp.js";import{T,I as me}from"./TextField-GEjcJewa.js";import{F as pe,S as xe}from"./Select-BXcoeulH.js";import"./useThemeProps-CpDca6ZV.js";import"./styled-DgJJown5.js";const K=t=>{const R={minLength:t.length>=8,hasUpperCase:/[A-Z]/.test(t),hasLowerCase:/[a-z]/.test(t),hasNumber:/\d/.test(t),hasSpecialChar:/[!@#$%^&*(),.?":{}|<>]/.test(t)},y=Object.entries(R).filter(([d,I])=>!I).map(([d])=>{switch(d){case"minLength":return"Password must be at least 8 characters long";case"hasUpperCase":return"Password must contain at least one uppercase letter";case"hasLowerCase":return"Password must contain at least one lowercase letter";case"hasNumber":return"Password must contain at least one number";case"hasSpecialChar":return"Password must contain at least one special character";default:return""}});return{isValid:y.length===0,errors:y}},ge=()=>{const{user:t,logout:R}=re(),y=te(),d=X(),[I,x]=b.useState(!1),[C,v]=b.useState(!1),[w,U]=b.useState({firstName:"",lastName:"",email:"",phone:"",role:""}),[g,N]=b.useState({currentPassword:"",newPassword:"",confirmPassword:""});b.useEffect(()=>{t&&(U({firstName:t.firstName||"",lastName:t.lastName||"",email:t.email||"",phone:t.phone||"",role:t.role||"user"}),v(!!t.googleId))},[t]);const M=o=>{const{name:r,value:s}=o.target;U({...w,[r]:s})},O=o=>{const{name:r,value:s}=o.target;N({...g,[r]:s})},q=async o=>{try{const s=await(await fetch(o)).blob();return new Promise((i,l)=>{const n=new FileReader;n.onload=()=>{const c=n.result.split(",")[1];i(c)},n.onerror=()=>l(new Error("Failed to convert image to base64")),n.readAsDataURL(s)})}catch(r){throw console.error("Error converting image to base64:",r),r}},J=async o=>{if(o&&o.preventDefault(),!(t!=null&&t.id)){d.error("User not authenticated");return}x(!0);try{const r=await L.updateProfile(t.id,w);r.success?d.success("Profile updated successfully"):d.error(r.message||"Failed to update profile")}catch(r){d.error(r.message||"An error occurred while updating profile")}finally{x(!1)}},H=async o=>{var s,i,l;if(o.preventDefault(),C){d.warning("Google-authenticated accounts cannot change passwords here. Please use Google's account settings to manage your password.",{duration:5e3});return}const r=K(g.newPassword);if(!r.isValid){r.errors.forEach(n=>d.error(n));return}if(g.newPassword!==g.confirmPassword){d.error("New passwords don't match");return}x(!0);try{const n=await L.changePassword(g.currentPassword,g.newPassword);n.success&&(d.success(n.message),N({currentPassword:"",newPassword:"",confirmPassword:""}))}catch(n){(s=n.message)!=null&&s.includes("Google-authenticated")||(i=n.message)!=null&&i.includes("social login")||(l=n.message)!=null&&l.includes("Cannot change password for this account type")?(v(!0),d.warning("Google-authenticated accounts cannot change passwords here. Please use Google's account settings to manage your password.",{duration:5e3})):d.error(n.message||"Failed to update password")}finally{x(!1)}},V=async()=>{x(!0);try{const o=await se.deactivateAccount();o.success?(d.success(o.message||"Account deleted successfully"),await R(),y("/account-deactivated",{state:{email:t==null?void 0:t.email}})):d.error(o.message||"Failed to delete account")}catch(o){d.error(o.message||"An error occurred while deleting account")}finally{x(!1)}},D=async(o,r)=>{x(!0);try{const s=K(r);if(!s.isValid){s.errors.forEach(l=>d.error(l));return}const i=await L.updatePassword(o,r);i.success&&(d.success(i.message),i.accessToken&&localStorage.setItem("authToken",i.accessToken),y("/login"))}catch(s){d.error(s.message)}finally{x(!1)}},k=async(o,r)=>{try{return new Promise((s,i)=>{const l=new FileReader;l.onload=async()=>{const n=l.result;try{r&&r(10);const c=Date.now(),f={base64Image:n,avatarId:"custom-upload",uniqueId:c};r&&r(30);const h=await fetch("http://localhost:5000/api/upload/avatar/base64",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("authToken")}`},credentials:"include",body:JSON.stringify(f)});if(r&&r(80),!h.ok)throw new Error("Upload failed");const j=await h.json();console.log("Avatar upload response:",j),r&&r(100);const P=j.avatar||j.avatarUrl,a=localStorage.getItem("user");if(a){const u=JSON.parse(a);u.avatar=P,localStorage.setItem("user",JSON.stringify(u))}s(P)}catch(c){console.error("Error in avatar upload:",c),i(c)}},l.onerror=()=>{i(new Error("Error reading file"))},l.readAsDataURL(o)})}catch(s){throw console.error("Avatar upload error:",s),s}},Y=async o=>new Promise((r,s)=>{const i=new Image;i.onload=()=>{const l=document.createElement("canvas"),n=l.getContext("2d");let c=i.width,f=i.height;const h=800;c>f&&c>h?(f*=h/c,c=h):f>h&&(c*=h/f,f=h),l.width=c,l.height=f,n.drawImage(i,0,0,c,f),r(l.toDataURL("image/jpeg",.7))},i.onerror=s,i.src=o});return{user:t,formData:w,passwordData:g,isLoading:I,isGoogleAccount:C,handleInputChange:M,handlePasswordChange:O,uploadAvatar:k,uploadDefaultAvatar:async(o,r)=>{try{x(!0);const s=r.split(".").pop().toLowerCase(),i=`image/${s==="svg"?"svg+xml":s}`,l=await q(r),n=`data:${i};base64,${l}`,c=await Y(n),f={avatarBase64:c,avatarId:o,uniqueId:(t==null?void 0:t.id)||Date.now(),transformation:{width:400,height:400,crop:"fill",quality:"auto",format:"webp"}};if(c.length>1e6){const h=Math.ceil(c.length/1e6),j=Math.ceil(c.length/h);for(let P=0;P<h;P++){const a=c.slice(P*j,(P+1)*j);if(f.chunk={data:a,index:P,total:h},!(await fetch("http://localhost:5000/api/upload/default-avatar",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("authToken")}`},credentials:"include",body:JSON.stringify(f)})).ok)throw new Error("Failed to upload avatar chunk")}}else{const h=await fetch("http://localhost:5000/api/upload/default-avatar",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("authToken")}`},credentials:"include",body:JSON.stringify(f)});if(!h.ok){const j=await h.json();throw new Error(j.message||"Failed to upload avatar")}}}catch(s){throw console.error("Error uploading default avatar:",s),d.error(s.message||"Failed to upload avatar"),s}finally{x(!1)}},originalHandleProfileSubmit:J,handlePasswordSubmit:H,handleDeactivateAccount:V,handlePasswordReset:D}},G=[{id:"avatar-1",src:"/avatars/1.svg",alt:"Avatar 1"},{id:"avatar-2",src:"/avatars/2.svg",alt:"Avatar 2"},{id:"avatar-3",src:"/avatars/3.svg",alt:"Avatar 3"},{id:"avatar-4",src:"/avatars/4.svg",alt:"Avatar 4"},{id:"avatar-5",src:"/avatars/5.svg",alt:"Avatar 5"},{id:"avatar-6",src:"/avatars/6.svg",alt:"Avatar 6"},{id:"default-avatar",src:"/avatars/7.svg",alt:"Default Avatar"}],fe=[{value:"male",label:"Male"},{value:"female",label:"Female"},{value:"non-binary",label:"Non-binary"},{value:"transgender",label:"Transgender"},{value:"other",label:"Other"},{value:"prefer-not-to-say",label:"Prefer not to say"}],Ie=()=>{const t=oe(),R=he(t.breakpoints.down("md")),[y,d]=b.useState("profile"),I=b.useRef(null),x=X(),{user:C,formData:v,passwordData:w,isLoading:U,handleInputChange:g,handlePasswordChange:N,handlePasswordSubmit:M,originalHandleProfileSubmit:O,isGoogleAccount:q,uploadDefaultAvatar:J,uploadAvatar:H,userAvatar:V}=ge(),[D,k]=b.useState(null),[Y,W]=b.useState(!1),[o,r]=b.useState(0),[s,i]=b.useState(!1),[l,n]=b.useState(V||"/avatars/default-avatar.svg");b.useEffect(()=>{if(C&&C.avatar){const a=`?t=${Date.now()}`,u=G.find(A=>A.id===C.avatar);u?(n(u.src),k(u.id)):(n(`${C.avatar}${a}`),W(!0))}},[C]);const c=[{id:"profile",icon:"profile",label:"Profile"},{id:"security",icon:"security",label:"Security"}],f=a=>{k(a),W(!1);const u=G.find(A=>A.id===a);u&&(n(u.src),g({target:{name:"avatar",value:a}}))},h=async a=>{if(a.preventDefault(),D&&!Y)try{const u=G.find(A=>A.id===D);if(u){const A=await J(D,u.src);g({target:{name:"avatar",value:A}});const F=`?t=${Date.now()}`;n(`${A}${F}`)}}catch(u){x.error("Error uploading avatar: "+(u.message||"Unknown error"));return}await O(a)},j=()=>{var a;(a=I.current)==null||a.click()},P=async a=>{var F;const u=(F=a.target.files)==null?void 0:F[0];if(!u)return;if(!["image/jpeg","image/png","image/gif","image/jpg"].includes(u.type)){x.error("Please select a valid image file (JPEG, PNG, GIF)");return}if(u.size>2*1024*1024){x.error("Image must be less than 2MB");return}i(!0),r(10);try{const E=await H(u,$=>{r($)});W(!0),k(null);const ee=`?t=${Date.now()}`,ae=`${E}${ee}`;n(ae),g({target:{name:"avatar",value:E}});try{(await L.updateProfile(C.id,{...v,avatar:E})).success&&console.log("Profile updated with new avatar")}catch($){console.error("Error saving avatar to profile:",$)}x.success("Avatar uploaded successfully!")}catch(E){x.error(E.message||"Failed to upload avatar")}finally{i(!1),I.current&&(I.current.value="")}};return e.jsxs("div",{className:"min-h-screen bg-gray-50",children:[U&&e.jsx(ne,{}),e.jsx(m,{sx:{py:{xs:4,md:5},px:3,background:"linear-gradient(135deg, #10B981 0%, #047857 100%)",boxShadow:"0 4px 12px rgba(0,0,0,0.08)"},children:e.jsxs(_,{maxWidth:"lg",children:[e.jsx(S,{variant:"h4",sx:{fontWeight:700,color:"white",mb:1},children:"My Profile"}),e.jsx(S,{variant:"subtitle1",sx:{color:"rgba(255,255,255,0.85)",fontWeight:400},children:"Manage your personal information and account security"})]})}),e.jsx(_,{maxWidth:"lg",sx:{py:{xs:3,md:5},px:{xs:2,sm:3}},children:e.jsxs(p,{container:!0,spacing:3,children:[e.jsx(p,{item:!0,xs:12,md:3,children:e.jsxs(z,{elevation:0,sx:{borderRadius:2,border:"1px solid",borderColor:"divider",position:"sticky",top:16,overflow:"hidden"},children:[e.jsxs(m,{sx:{p:3,display:"flex",flexDirection:"column",alignItems:"center",backgroundColor:"white"},children:[e.jsx(Q,{src:l,alt:v.firstName,sx:{width:90,height:90,mb:2,border:"3px solid white",boxShadow:"0 4px 10px rgba(0,0,0,0.1)"}},`sidebar-avatar-${l}`),e.jsxs(S,{variant:"h6",sx:{fontWeight:600,textAlign:"center"},children:[v.firstName," ",v.lastName]}),e.jsx(S,{variant:"body2",color:"text.secondary",sx:{mb:1,textAlign:"center"},children:v.email}),e.jsx(m,{sx:{px:2,py:.5,borderRadius:6,bgcolor:"primary.50",color:"primary.700",textTransform:"capitalize",fontSize:13,fontWeight:500},children:v.role||"User"})]}),e.jsx(ie,{}),e.jsx(m,{sx:{p:2,display:R?"flex":"block",justifyContent:"center",gap:2},children:c.map(a=>e.jsx(B,{variant:y===a.id?"contained":"text",color:y===a.id?"primary":"inherit",onClick:()=>d(a.id),fullWidth:!R,startIcon:e.jsx(le,{name:a.icon}),sx:{py:1.5,justifyContent:"flex-start",mb:R?0:1,borderRadius:1.5,textAlign:"left"},children:a.label},a.id))})]})}),e.jsxs(p,{item:!0,xs:12,md:9,children:[y==="profile"&&e.jsxs(m,{children:[e.jsxs(z,{elevation:0,sx:{p:{xs:3,md:4},mb:3,borderRadius:2,border:"1px solid",borderColor:"divider"},children:[e.jsx(S,{variant:"h6",sx:{mb:3,fontWeight:600,color:"text.primary"},children:"Profile Picture"}),e.jsxs(p,{container:!0,spacing:3,children:[e.jsx(p,{item:!0,xs:12,sm:6,children:e.jsxs(m,{sx:{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",mb:{xs:3,sm:0}},children:[e.jsx(Q,{src:l,alt:v.firstName,sx:{width:120,height:120,border:"3px solid white",boxShadow:"0 4px 10px rgba(0,0,0,0.1)",mb:3}},`profile-avatar-${l}`),e.jsx(B,{variant:"outlined",startIcon:e.jsx(de,{size:16}),onClick:j,color:"primary",sx:{borderRadius:2},children:"Upload New Photo"}),e.jsx("input",{type:"file",ref:I,style:{display:"none"},accept:"image/jpeg, image/png, image/gif",onChange:P}),s&&e.jsxs(m,{sx:{mt:2,width:"100%",maxWidth:200},children:[e.jsx(m,{sx:{height:6,borderRadius:3,bgcolor:Z(t.palette.primary.main,.2),overflow:"hidden"},children:e.jsx(m,{sx:{height:"100%",borderRadius:3,width:`${o}%`,bgcolor:"primary.main",transition:"width 0.3s ease-in-out"}})}),e.jsxs(S,{variant:"caption",sx:{display:"block",textAlign:"center",mt:1},children:["Uploading... ",o,"%"]})]})]})}),e.jsxs(p,{item:!0,xs:12,sm:6,children:[e.jsx(S,{variant:"subtitle2",sx:{mb:2,fontWeight:600},children:"Select Default Avatar"}),e.jsx(m,{sx:{display:"grid",gridTemplateColumns:"repeat(auto-fill, minmax(60px, 1fr))",gap:1.5},children:G.map(a=>e.jsxs(m,{onClick:()=>f(a.id),sx:{p:1,border:"2px solid",borderColor:D===a.id?"primary.main":Z("#000",.06),borderRadius:2,cursor:"pointer",position:"relative",transition:"all 0.2s ease","&:hover":{borderColor:Z(t.palette.primary.main,.5),transform:"translateY(-2px)",boxShadow:"0 4px 8px rgba(0,0,0,0.05)"}},children:[e.jsx(Q,{src:a.src,alt:a.alt,sx:{width:"100%",height:"auto",aspectRatio:"1/1"}}),D===a.id&&e.jsx(m,{sx:{position:"absolute",top:-8,right:-8,bgcolor:"primary.main",borderRadius:"50%",width:22,height:22,display:"flex",alignItems:"center",justifyContent:"center"},children:e.jsx(ce,{size:14,color:"white"})})]},a.id))})]})]})]}),e.jsxs(z,{elevation:0,sx:{p:{xs:3,md:4},borderRadius:2,border:"1px solid",borderColor:"divider"},children:[e.jsx(S,{variant:"h6",sx:{mb:3,fontWeight:600,color:"text.primary"},children:"Personal Information"}),e.jsx("form",{onSubmit:h,children:e.jsxs(p,{container:!0,spacing:3,children:[e.jsx(p,{item:!0,xs:12,sm:6,children:e.jsx(T,{fullWidth:!0,label:"First Name",name:"firstName",value:v.firstName,onChange:g,required:!0,variant:"outlined",InputProps:{sx:{borderRadius:1.5}}})}),e.jsx(p,{item:!0,xs:12,sm:6,children:e.jsx(T,{fullWidth:!0,label:"Last Name",name:"lastName",value:v.lastName,onChange:g,required:!0,variant:"outlined",InputProps:{sx:{borderRadius:1.5}}})}),e.jsx(p,{item:!0,xs:12,sm:6,children:e.jsx(T,{fullWidth:!0,label:"Email",name:"email",type:"email",value:v.email,onChange:g,required:!0,variant:"outlined",disabled:!0,InputProps:{sx:{borderRadius:1.5,bgcolor:"action.disabledBackground","& .MuiInputBase-input.Mui-disabled":{WebkitTextFillColor:"text.secondary"}}},helperText:"Email cannot be changed"})}),e.jsx(p,{item:!0,xs:12,sm:6,children:e.jsxs(pe,{fullWidth:!0,variant:"outlined",children:[e.jsx(me,{id:"gender-label",children:"Gender"}),e.jsx(xe,{labelId:"gender-label",id:"gender",name:"gender",value:v.gender||"prefer-not-to-say",label:"Gender",onChange:g,sx:{borderRadius:1.5},children:fe.map(a=>e.jsx(ue,{value:a.value,children:a.label},a.value))})]})}),e.jsx(p,{item:!0,xs:12,children:e.jsx(m,{sx:{display:"flex",justifyContent:"flex-end",mt:2},children:e.jsx(B,{type:"submit",variant:"contained",color:"primary",size:"large",sx:{borderRadius:2,px:4},children:"Save Changes"})})})]})})]})]}),y==="security"&&e.jsxs(z,{elevation:0,sx:{p:{xs:3,md:4},borderRadius:2,border:"1px solid",borderColor:"divider"},children:[e.jsx(S,{variant:"h6",sx:{mb:3,fontWeight:600,color:"text.primary"},children:"Security Settings"}),q?e.jsx(m,{sx:{p:3,borderRadius:2,mb:3,bgcolor:"info.50",borderLeft:"4px solid",borderColor:"info.main"},children:e.jsxs(m,{sx:{display:"flex",alignItems:"flex-start"},children:[e.jsx(m,{sx:{mr:2,color:"info.main",display:"flex"},children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5",viewBox:"0 0 20 20",fill:"currentColor",children:e.jsx("path",{fillRule:"evenodd",d:"M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z",clipRule:"evenodd"})})}),e.jsx(S,{sx:{color:"info.dark"},children:"You signed in with Google. To change your password, please visit your Google account settings."})]})}):e.jsx("form",{onSubmit:M,children:e.jsxs(p,{container:!0,spacing:3,children:[e.jsx(p,{item:!0,xs:12,children:e.jsx(T,{fullWidth:!0,label:"Current Password",name:"currentPassword",type:"password",value:w.currentPassword,onChange:N,required:!0,variant:"outlined",InputProps:{sx:{borderRadius:1.5}}})}),e.jsx(p,{item:!0,xs:12,sm:6,children:e.jsx(T,{fullWidth:!0,label:"New Password",name:"newPassword",type:"password",value:w.newPassword,onChange:N,required:!0,helperText:"Must be at least 8 characters long",variant:"outlined",InputProps:{sx:{borderRadius:1.5}}})}),e.jsx(p,{item:!0,xs:12,sm:6,children:e.jsx(T,{fullWidth:!0,label:"Confirm New Password",name:"confirmPassword",type:"password",value:w.confirmPassword,onChange:N,required:!0,error:w.newPassword!==w.confirmPassword&&w.confirmPassword!=="",helperText:w.newPassword!==w.confirmPassword&&w.confirmPassword!==""?"Passwords don't match":"",variant:"outlined",InputProps:{sx:{borderRadius:1.5}}})}),e.jsx(p,{item:!0,xs:12,children:e.jsx(m,{sx:{display:"flex",justifyContent:"flex-end",mt:2},children:e.jsx(B,{type:"submit",variant:"contained",color:"primary",size:"large",sx:{borderRadius:2,px:4},children:"Update Password"})})})]})})]})]})]})})]})};export{Ie as default};
