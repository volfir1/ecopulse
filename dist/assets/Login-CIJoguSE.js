import{u as K,b as Q,d as X,e as Z,r as g,f as d,j as t,L as _,p as w,U as ee,t as te,g as se,h as C,i as E,M as ae}from"./index-CeiZKB8G.js";import{c as ie,a as F,F as re,b as oe,d as $,E as T}from"./index.esm-CrTxtpVV.js";import{c as ne}from"./crosswalk-C791ooMc.js";import{R as ce}from"./refresh-cw-DlOnahB6.js";import{L as le}from"./lock-BTl28dPZ.js";const de=()=>{const{login:j,googleSignIn:N,setUser:k,setIsAuthenticated:S}=K(),o=Q();X();const a=Z(),[c,u]=g.useState(!1),[h,n]=g.useState(null),[l,x]=g.useState(""),[A,v]=g.useState(!1),[m,f]=g.useState(!1),[p,q]=g.useState(null),U=ie({email:F().email("Invalid email format").required("Email is required"),password:F().required("Password is required")}),W={email:"",password:""},b=()=>u(!0),y=()=>u(!1),Y=e=>{a.success(`Welcome back, ${e.firstName||"User"}!`)},R=(e,s)=>{const r={...e,isVerified:!0};return localStorage.setItem("user",JSON.stringify(r)),e.accessToken&&localStorage.setItem("authToken",e.accessToken),k(r),S(!0),r},I=e=>{const s=e.role==="admin"?"/admin/dashboard":"/dashboard";o(s,{replace:!0})},G=(e,s=!1)=>{o("/reactivate-account",{state:{email:e,isAutoDeactivated:!0,hasError:s,message:s?"We encountered an issue sending the reactivation email. Please try requesting a new one.":"A reactivation link has been sent to your email."},replace:!0})},M=e=>{o("/login",{state:{email:e,isAutoDeactivated:!0,message:"Your account has been automatically deactivated due to inactivity. A reactivation link has been sent to your email."},replace:!0})},O=async e=>{console.log("Handling auto-deactivated account:",e),f(!0),x(e),a.info("Account deactivated due to inactivity. Sending reactivation email...");try{console.log("Sending reactivation request to server...");const s=await d.requestReactivation(e);console.log("Reactivation request response:",s),s.success?(a.success("Reactivation email sent successfully. Please check your inbox."),o("/login",{state:{email:e,isAutoDeactivated:!0,emailSent:!0,message:"Your account has been automatically deactivated due to inactivity. A reactivation link has been sent to your email."},replace:!0})):(a.error(s.message||"Problem sending reactivation email. Please try again."),o("/reactivate-account",{state:{email:e,isAutoDeactivated:!0,emailSent:!1,hasError:!0,errorMessage:s.message,message:"We encountered an issue sending the reactivation email. You can request a new one below."},replace:!0}))}catch(s){console.error("Critical error in auto-deactivated account flow:",s),a.error("An unexpected error occurred. Please try again."),o("/reactivate-account",{state:{email:e,isAutoDeactivated:!0,hasError:!0,emailSent:!1,message:"We encountered a technical issue. Please try requesting a new reactivation email."},replace:!0})}finally{u(!1)}},z=async(e,s)=>{q({email:e,deactivatedAt:s.deactivatedAt,tokenExpired:s.tokenExpired}),f(!0),x(e),a.info("Account deactivated due to inactivity. Reactivation link sent."),(await d.requestReactivation(e)).success?M(e):G(e,!0)},D=async e=>{if(!e.user){a.error("Invalid server response");return}const s=R(e.user);a.success("Account reactivated. Welcome back!"),I(s)},B=async()=>{if(!l){a.error("Email is required");return}b();try{const e=await d.requestReactivation(l);e.success?(a.success("Reactivation email sent. Please check your inbox and follow the instructions."),G(l)):a.error(e.message||"Failed to send reactivation email")}catch(e){console.error("Reactivation request error:",e),n(e.message||"Failed to request reactivation"),a.error(e.message||"Failed to request reactivation")}finally{y()}},P=e=>{o("/verify-email",{state:{userId:e.userId,email:e.email||""}}),a.info(e.message||"Please verify your email")},J=async e=>{if(!e.user){a.error("Invalid user data received");return}const s=R(e.user);a.success(`Welcome, ${s.firstName||"User"}!`),I(s)},H=e=>{console.error("Google sign-in error handler:",e);let s=e.message||"Google sign-in failed";e.code==="auth/popup-closed-by-user"?(s="Sign-in process was cancelled",a.info("Sign-in cancelled")):e.code==="auth/popup-blocked"&&(s="Popup blocked - try direct redirect",a.error("Enable popups or use email sign-in"),v(!0)),n(s),["auth/popup-closed-by-user","auth/popup-blocked"].includes(e.code)||a.error(s)};return{isLoading:c,authError:h,handleSubmit:async(e,{setSubmitting:s})=>{console.log("Login attempt:",{email:e.email}),s(!0),n(null),b();try{const r=await d.checkAccountStatus(e.email);if(console.log("Account status check result:",r),r.exists&&r.isAutoDeactivated){console.log("Account is auto-deactivated:",r),q({email:e.email,deactivatedAt:r.deactivatedAt,tokenExpired:r.tokenExpired});try{await d.login(e.email,e.password)}catch(L){console.log("Login attempt on deactivated account (for notification):",L.message)}await O(e.email);return}const i=await j(e.email,e.password);if(console.log("Login result:",i),i&&i.wasReactivated){await D(i);return}if(!i||!i.success){const L=(i==null?void 0:i.message)||"Login failed. Please try again.";a.error(L);return}if(!i.user){a.error("Invalid response from server");return}if(console.log("Checking verification status:",{userEmail:i.user.email,explicitVerification:!!i.isVerified,userVerification:!!i.user.isVerified,requireVerification:!!i.requireVerification}),i.requireVerification===!0){console.log("Server explicitly requires verification"),P({userId:i.user.id||i.userId,email:e.email,message:i.message});return}console.log("User considered verified, proceeding with login");const V=R(i.user);Y(V),I(V)}catch(r){console.error("Login submission error:",r),n(r.message||"Authentication failed"),a.error(r.message||"Authentication failed")}finally{s(!1),y()}},handleGoogleSignIn:async()=>{try{n(null),v(!1),b(),console.log("Starting Google sign-in attempt");const e=await N();if(console.log("Google sign-in result received:",e),e&&e.email){const s=await d.checkAccountStatus(e.email);if(console.log("Account status check result:",s),s.exists&&s.isAutoDeactivated){await z(e.email,s);return}if(e.wasReactivated){await D(e);return}}if(e!=null&&e.requireVerification){P(e);return}if(e!=null&&e.success){await J(e);return}throw new Error((e==null?void 0:e.message)||"Google authentication failed")}catch(e){console.error("Google sign-in error:",e),H(e)}finally{y()}},handleGoogleRedirectSignIn:async()=>{try{n(null),b(),a.info("Redirecting to Google sign-in..."),await d.googleSignInWithRedirect()}catch(e){console.error("Google redirect sign-in error:",e),n(e.message||"Google sign-in redirect failed"),a.error(e.message||"Google sign-in redirect failed"),y()}},showRedirectOption:A,initialValues:W,validationSchema:U,isAutoDeactivated:m,recoveryEmail:l,setRecoveryEmail:x,handleRequestReactivation:B,deactivationInfo:p}},be=()=>{const{handleGoogleSignIn:j,handleGoogleRedirectSignIn:N,showRedirectOption:k,handleSubmit:S,initialValues:o,validationSchema:a,isLoading:c,authError:u,isDeactivated:h,showReactivationOption:n,lockoutInfo:l,recoveryEmail:x,setRecoveryEmail:A,handleRequestReactivation:v}=de();return t.jsxs(t.Fragment,{children:[c&&t.jsx(_,{}),t.jsxs("div",{className:"flex min-h-screen",children:[t.jsxs("div",{className:"flex flex-col items-center justify-center flex-1 p-12 text-center",style:{background:`linear-gradient(135deg, ${w.main}, ${w.dark})`},children:[t.jsx("img",{src:"/logo.png",alt:"EcoPulse Logo",className:"w-32 h-32 mb-6"}),t.jsx("h1",{className:"mb-6 text-5xl font-bold text-white",children:"EcoPulse"}),t.jsx("p",{className:"text-lg leading-relaxed text-white/80 max-w-md",children:"Join our community of eco-conscious individuals and businesses. Together, we can make a difference for a sustainable future."})]}),t.jsxs("div",{className:"relative flex items-center justify-center w-1/2 bg-center bg-cover",style:{backgroundImage:`url(${ne})`,backgroundSize:"cover",backgroundPosition:"center"},children:[t.jsx("div",{className:"absolute inset-0",style:{backgroundColor:"rgba(255, 255, 255, 0.9)"}}),t.jsxs("div",{className:"relative z-10 w-full max-w-md p-8 mx-12 bg-white shadow-xl rounded-3xl",children:[t.jsx("div",{className:"flex justify-center mb-4",children:t.jsx("div",{className:"w-16 h-16 rounded-full flex items-center justify-center",style:{border:`2px solid ${w.main}`},children:t.jsx(ee,{className:"w-8 h-8",style:{color:w.main}})})}),t.jsx("h2",{className:"mb-6 text-2xl font-bold text-center",style:{color:te.main},children:h?"Account Deactivated":"Login"}),h&&t.jsxs("div",{className:"space-y-6",children:[l&&t.jsxs("div",{className:"p-4 bg-yellow-50 border border-yellow-200 rounded-lg space-y-3",children:[t.jsxs("div",{className:"flex items-center space-x-2 text-yellow-800",children:[t.jsx(se,{className:"w-5 h-5"}),t.jsx("h3",{className:"font-medium",children:"Reactivation Locked"})]}),t.jsxs("p",{className:"text-sm text-yellow-700",children:["Your account reactivation is currently locked. Please try again in ",l.hours," hours."]})]}),n&&t.jsxs("div",{className:"p-4 bg-green-50 border border-green-200 rounded-lg space-y-3",children:[t.jsxs("div",{className:"flex items-center space-x-2 text-green-800",children:[t.jsx(C,{className:"w-5 h-5"}),t.jsx("h3",{className:"font-medium",children:"Account Deactivated"})]}),t.jsx("p",{className:"text-sm text-green-700",children:"Your account has been deactivated. A reactivation link has been sent to your email."}),t.jsxs("div",{className:"space-y-2 pt-2",children:[t.jsx("p",{className:"text-sm font-medium text-gray-700",children:"Didn't receive the email? Request a new reactivation link:"}),t.jsxs("div",{className:"flex space-x-2",children:[t.jsx("input",{type:"email",value:x,onChange:m=>A(m.target.value),placeholder:"Your email",className:"flex-1 h-10 px-3 border rounded-lg text-sm"}),t.jsxs("button",{onClick:v,disabled:c,className:"h-10 px-4 bg-green-700 text-white rounded-lg font-medium hover:bg-green-800 transition-colors disabled:opacity-50 disabled:cursor-not-allowed text-sm flex items-center",children:[t.jsx(ce,{className:"w-4 h-4 mr-2"}),"Send"]})]})]})]}),t.jsx("div",{className:"pt-4",children:t.jsx(E,{to:"/login",className:"w-full h-10 flex items-center justify-center bg-gray-200 text-gray-800 rounded-lg font-medium hover:bg-gray-300 transition-colors text-sm",children:"Back to Login"})})]}),!h&&t.jsx(t.Fragment,{children:t.jsx(re,{initialValues:o,validationSchema:a,onSubmit:S,children:({isSubmitting:m,touched:f,errors:p})=>t.jsxs(oe,{className:"space-y-4",children:[t.jsxs("div",{className:"space-y-1",children:[t.jsxs("div",{className:"relative flex items-center",children:[t.jsx(ae,{className:"absolute left-3 w-4 h-4 text-gray-400"}),t.jsx($,{type:"email",name:"email",className:`w-full h-10 pl-9 pr-3 border rounded-lg text-sm ${f.email&&p.email?"border-red-500":"border-gray-300"}`,placeholder:"Email"})]}),t.jsx(T,{name:"email",component:"div",className:"text-xs text-red-500"})]}),t.jsxs("div",{className:"space-y-1",children:[t.jsxs("div",{className:"relative flex items-center",children:[t.jsx(le,{className:"absolute left-3 w-4 h-4 text-gray-400"}),t.jsx($,{type:"password",name:"password",className:`w-full h-10 pl-9 pr-3 border rounded-lg text-sm ${f.password&&p.password?"border-red-500":"border-gray-300"}`,placeholder:"Password"})]}),t.jsx(T,{name:"password",component:"div",className:"text-xs text-red-500"})]}),t.jsx("div",{className:"text-right",children:t.jsx(E,{to:"/forgot-password",className:"text-xs text-green-700 hover:underline",children:"Forgot password?"})}),t.jsx("button",{type:"submit",disabled:m||c,className:"w-full h-10 bg-green-700 text-white rounded-lg font-medium hover:bg-green-800 transition-colors disabled:opacity-50 disabled:cursor-not-allowed text-sm",children:m||c?"Logging in...":"Login"}),t.jsxs("div",{className:"relative py-2",children:[t.jsx("div",{className:"absolute inset-0 flex items-center",children:t.jsx("div",{className:"w-full border-t border-gray-300"})}),t.jsx("div",{className:"relative flex justify-center",children:t.jsx("span",{className:"px-4 text-xs text-gray-500 bg-white",children:"Or continue with"})})]}),t.jsxs("button",{type:"button",onClick:j,disabled:c,className:"w-full h-10 flex items-center justify-center gap-2 border border-gray-300 rounded-lg text-gray-700 font-medium hover:bg-gray-50 transition-colors disabled:opacity-50 disabled:cursor-not-allowed text-sm",children:[t.jsx("img",{src:"/google.svg",alt:"Google",className:"w-4 h-4"}),t.jsx("span",{children:"Sign in with Google"})]}),k&&t.jsxs("div",{className:"mt-4 p-4 bg-blue-50 border border-blue-200 rounded-lg space-y-3",children:[t.jsxs("div",{className:"flex items-center space-x-2 text-blue-800",children:[t.jsx(C,{className:"w-5 h-5"}),t.jsx("h3",{className:"font-medium",children:"Popup Blocked"})]}),t.jsx("p",{className:"text-sm text-blue-700",children:"Your browser blocked the sign-in popup. You can enable popups in your browser settings or use the redirect method instead."}),t.jsxs("button",{type:"button",onClick:N,disabled:c,className:"w-full h-10 flex items-center justify-center gap-2 bg-blue-700 text-white rounded-lg font-medium hover:bg-blue-800 transition-colors disabled:opacity-50 disabled:cursor-not-allowed text-sm",children:[t.jsx("img",{src:"/google.svg",alt:"Google",className:"w-4 h-4 invert"}),t.jsx("span",{children:"Sign in with Google (Redirect)"})]})]}),u&&t.jsx("div",{className:"p-3 bg-red-50 border border-red-200 rounded-lg text-sm text-red-700",children:u}),t.jsxs("div",{className:"text-center text-xs text-gray-600",children:["Not a member?"," ",t.jsx(E,{to:"/register",className:"font-medium text-green-700 hover:underline",children:"Sign up now"})]})]})})})]})]})]})]})};export{be as default};
