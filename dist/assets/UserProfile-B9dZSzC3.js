import{u as re,b as te,e as X,r as b,f as se,a0 as oe,j as e,L as ne,B as m,T as j,P as k,a1 as Q,D as ie,a as z,Y as le,a2 as ce,a3 as Z,s as de,a4 as ue}from"./index-BN0NLy4X.js";import{u as F}from"./userService-89PvBtsH.js";import{u as he}from"./index-B8U9fKH1.js";import{C as _}from"./Container-C2Kj_-ax.js";import{G as p}from"./Grid-CgXu5irq.js";import{T as U,I as me}from"./TextField-Bsv3TW2t.js";import{F as pe,S as ge}from"./Select-BvIDhjGm.js";import"./axios-CmsuhreG.js";import"./useThemeProps-CQcjcwiv.js";import"./styled-3tO3uOdC.js";const K=t=>{const I={minLength:t.length>=8,hasUpperCase:/[A-Z]/.test(t),hasLowerCase:/[a-z]/.test(t),hasNumber:/\d/.test(t),hasSpecialChar:/[!@#$%^&*(),.?":{}|<>]/.test(t)},y=Object.entries(I).filter(([l,C])=>!C).map(([l])=>{switch(l){case"minLength":return"Password must be at least 8 characters long";case"hasUpperCase":return"Password must contain at least one uppercase letter";case"hasLowerCase":return"Password must contain at least one lowercase letter";case"hasNumber":return"Password must contain at least one number";case"hasSpecialChar":return"Password must contain at least one special character";default:return""}});return{isValid:y.length===0,errors:y}},xe=()=>{const{user:t,logout:I}=re(),y=te(),l=X(),[C,g]=b.useState(!1),[P,v]=b.useState(!1),[w,G]=b.useState({firstName:"",lastName:"",email:"",phone:"",role:""}),[f,D]=b.useState({currentPassword:"",newPassword:"",confirmPassword:""});b.useEffect(()=>{t&&(G({firstName:t.firstName||"",lastName:t.lastName||"",email:t.email||"",phone:t.phone||"",role:t.role||"user"}),v(!!t.googleId))},[t]);const M=n=>{const{name:r,value:s}=n.target;G({...w,[r]:s})},O=n=>{const{name:r,value:s}=n.target;D({...f,[r]:s})},q=async n=>{try{const s=await(await fetch(n)).blob();return new Promise((i,c)=>{const o=new FileReader;o.onload=()=>{const d=o.result.split(",")[1];i(d)},o.onerror=()=>c(new Error("Failed to convert image to base64")),o.readAsDataURL(s)})}catch(r){throw console.error("Error converting image to base64:",r),r}},J=async n=>{if(n&&n.preventDefault(),!(t!=null&&t.id)){l.error("User not authenticated");return}g(!0);try{const r=await F.updateProfile(t.id,w);r.success?l.success("Profile updated successfully"):l.error(r.message||"Failed to update profile")}catch(r){l.error(r.message||"An error occurred while updating profile")}finally{g(!1)}},H=async n=>{var s,i,c;if(n.preventDefault(),P){l.warning("Google-authenticated accounts cannot change passwords here. Please use Google's account settings to manage your password.",{duration:5e3});return}const r=K(f.newPassword);if(!r.isValid){r.errors.forEach(o=>l.error(o));return}if(f.newPassword!==f.confirmPassword){l.error("New passwords don't match");return}g(!0);try{const o=await F.changePassword(f.currentPassword,f.newPassword);o.success&&(l.success(o.message),D({currentPassword:"",newPassword:"",confirmPassword:""}))}catch(o){(s=o.message)!=null&&s.includes("Google-authenticated")||(i=o.message)!=null&&i.includes("social login")||(c=o.message)!=null&&c.includes("Cannot change password for this account type")?(v(!0),l.warning("Google-authenticated accounts cannot change passwords here. Please use Google's account settings to manage your password.",{duration:5e3})):l.error(o.message||"Failed to update password")}finally{g(!1)}},V=async()=>{g(!0);try{const n=await se.deactivateAccount();n.success?(l.success(n.message||"Account deleted successfully"),await I(),y("/account-deactivated",{state:{email:t==null?void 0:t.email}})):l.error(n.message||"Failed to delete account")}catch(n){l.error(n.message||"An error occurred while deleting account")}finally{g(!1)}},R=async(n,r)=>{g(!0);try{const s=K(r);if(!s.isValid){s.errors.forEach(c=>l.error(c));return}const i=await F.updatePassword(n,r);i.success&&(l.success(i.message),i.accessToken&&localStorage.setItem("authToken",i.accessToken),y("/login"))}catch(s){l.error(s.message)}finally{g(!1)}},T=async(n,r)=>{try{return new Promise((s,i)=>{const c=new FileReader;c.onload=async()=>{const o=c.result;try{r&&r(10);const d=Date.now(),h={base64Image:o,avatarId:"custom-upload",uniqueId:d};r&&r(30);const x=await fetch("http://localhost:5000/api/upload/avatar/base64",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("authToken")}`},credentials:"include",body:JSON.stringify(h)});if(r&&r(80),!x.ok)throw new Error("Upload failed");const A=await x.json();console.log("Avatar upload response:",A),r&&r(100);const N=A.avatar||A.avatarUrl,a=localStorage.getItem("user");if(a){const u=JSON.parse(a);u.avatar=N,localStorage.setItem("user",JSON.stringify(u))}s(N)}catch(d){console.error("Error in avatar upload:",d),i(d)}},c.onerror=()=>{i(new Error("Error reading file"))},c.readAsDataURL(n)})}catch(s){throw console.error("Avatar upload error:",s),s}},Y=async(n,r)=>{try{if(g(!0),!(t!=null&&t.id))throw new Error("User not authenticated");const s=r.split(".").pop().toLowerCase(),i=`image/${s==="svg"?"svg+xml":s}`,c=await q(r),o=`data:${i};base64,${c}`,d=await E(o);let h="";try{h=r;const x={...w,avatar:h},A=await F.updateProfile(t.id,x);if(!A.success)throw new Error(A.message||"Failed to update avatar");const N=localStorage.getItem("user");if(N){const a=JSON.parse(N);a.avatar=h,localStorage.setItem("user",JSON.stringify(a))}return l.success("Avatar updated successfully"),h}catch(x){throw console.error("Failed to update avatar:",x),x}}catch(s){throw console.error("Error updating avatar:",s),l.error(s.message||"Failed to update avatar"),s}finally{g(!1)}},E=async n=>new Promise((r,s)=>{const i=new Image;i.onload=()=>{const c=document.createElement("canvas"),o=c.getContext("2d");let d=i.width,h=i.height;const x=150;d>h&&d>x?(h*=x/d,d=x):h>x&&(d*=x/h,h=x),d=Math.floor(d),h=Math.floor(h),c.width=d,c.height=h,o.imageSmoothingQuality="high",o.drawImage(i,0,0,d,h),r(c.toDataURL("image/jpeg",.2))},i.onerror=s,i.src=n});return{user:t,formData:w,passwordData:f,isLoading:C,isGoogleAccount:P,handleInputChange:M,handlePasswordChange:O,uploadAvatar:T,uploadDefaultAvatar:Y,originalHandleProfileSubmit:J,handlePasswordSubmit:H,handleDeactivateAccount:V,handlePasswordReset:R}},B=[{id:"avatar-1",src:"/avatars/1.svg",alt:"Avatar 1"},{id:"avatar-2",src:"/avatars/2.svg",alt:"Avatar 2"},{id:"avatar-3",src:"/avatars/3.svg",alt:"Avatar 3"},{id:"avatar-4",src:"/avatars/4.svg",alt:"Avatar 4"},{id:"avatar-5",src:"/avatars/5.svg",alt:"Avatar 5"},{id:"avatar-6",src:"/avatars/6.svg",alt:"Avatar 6"},{id:"default-avatar",src:"/avatars/7.svg",alt:"Default Avatar"}],fe=[{value:"male",label:"Male"},{value:"female",label:"Female"},{value:"non-binary",label:"Non-binary"},{value:"transgender",label:"Transgender"},{value:"other",label:"Other"},{value:"prefer-not-to-say",label:"Prefer not to say"}],Re=()=>{const t=oe(),I=he(t.breakpoints.down("md")),[y,l]=b.useState("profile"),C=b.useRef(null),g=X(),{user:P,formData:v,passwordData:w,isLoading:G,handleInputChange:f,handlePasswordChange:D,handlePasswordSubmit:M,originalHandleProfileSubmit:O,isGoogleAccount:q,uploadDefaultAvatar:J,uploadAvatar:H,userAvatar:V}=xe(),[R,T]=b.useState(null),[Y,E]=b.useState(!1),[n,r]=b.useState(0),[s,i]=b.useState(!1),[c,o]=b.useState(V||"/avatars/default-avatar.svg");b.useEffect(()=>{if(P&&P.avatar){const a=`?t=${Date.now()}`,u=B.find(S=>S.id===P.avatar);u?(o(u.src),T(u.id)):(o(`${P.avatar}${a}`),E(!0))}},[P]);const d=[{id:"profile",icon:"profile",label:"Profile"},{id:"security",icon:"security",label:"Security"}],h=a=>{T(a),E(!1);const u=B.find(S=>S.id===a);u&&(o(u.src),f({target:{name:"avatar",value:a}}))},x=async a=>{if(a.preventDefault(),R&&!Y)try{const u=B.find(S=>S.id===R);if(u){const S=await J(R,u.src);f({target:{name:"avatar",value:S}});const $=`?t=${Date.now()}`;o(`${S}${$}`)}}catch(u){g.error("Error uploading avatar: "+(u.message||"Unknown error"));return}await O(a)},A=()=>{var a;(a=C.current)==null||a.click()},N=async a=>{var $;const u=($=a.target.files)==null?void 0:$[0];if(!u)return;if(!["image/jpeg","image/png","image/gif","image/jpg"].includes(u.type)){g.error("Please select a valid image file (JPEG, PNG, GIF)");return}if(u.size>2*1024*1024){g.error("Image must be less than 2MB");return}i(!0),r(10);try{const W=await H(u,L=>{r(L)});E(!0),T(null);const ee=`?t=${Date.now()}`,ae=`${W}${ee}`;o(ae),f({target:{name:"avatar",value:W}});try{(await F.updateProfile(P.id,{...v,avatar:W})).success&&console.log("Profile updated with new avatar")}catch(L){console.error("Error saving avatar to profile:",L)}g.success("Avatar uploaded successfully!")}catch(W){g.error(W.message||"Failed to upload avatar")}finally{i(!1),C.current&&(C.current.value="")}};return e.jsxs("div",{className:"min-h-screen bg-gray-50",children:[G&&e.jsx(ne,{}),e.jsx(m,{sx:{py:{xs:4,md:5},px:3,background:"linear-gradient(135deg, #10B981 0%, #047857 100%)",boxShadow:"0 4px 12px rgba(0,0,0,0.08)"},children:e.jsxs(_,{maxWidth:"lg",children:[e.jsx(j,{variant:"h4",sx:{fontWeight:700,color:"white",mb:1},children:"My Profile"}),e.jsx(j,{variant:"subtitle1",sx:{color:"rgba(255,255,255,0.85)",fontWeight:400},children:"Manage your personal information and account security"})]})}),e.jsx(_,{maxWidth:"lg",sx:{py:{xs:3,md:5},px:{xs:2,sm:3}},children:e.jsxs(p,{container:!0,spacing:3,children:[e.jsx(p,{item:!0,xs:12,md:3,children:e.jsxs(k,{elevation:0,sx:{borderRadius:2,border:"1px solid",borderColor:"divider",position:"sticky",top:16,overflow:"hidden"},children:[e.jsxs(m,{sx:{p:3,display:"flex",flexDirection:"column",alignItems:"center",backgroundColor:"white"},children:[e.jsx(Q,{src:c,alt:v.firstName,sx:{width:90,height:90,mb:2,border:"3px solid white",boxShadow:"0 4px 10px rgba(0,0,0,0.1)"}},`sidebar-avatar-${c}`),e.jsxs(j,{variant:"h6",sx:{fontWeight:600,textAlign:"center"},children:[v.firstName," ",v.lastName]}),e.jsx(j,{variant:"body2",color:"text.secondary",sx:{mb:1,textAlign:"center"},children:v.email}),e.jsx(m,{sx:{px:2,py:.5,borderRadius:6,bgcolor:"primary.50",color:"primary.700",textTransform:"capitalize",fontSize:13,fontWeight:500},children:v.role||"User"})]}),e.jsx(ie,{}),e.jsx(m,{sx:{p:2,display:I?"flex":"block",justifyContent:"center",gap:2},children:d.map(a=>e.jsx(z,{variant:y===a.id?"contained":"text",color:y===a.id?"primary":"inherit",onClick:()=>l(a.id),fullWidth:!I,startIcon:e.jsx(le,{name:a.icon}),sx:{py:1.5,justifyContent:"flex-start",mb:I?0:1,borderRadius:1.5,textAlign:"left"},children:a.label},a.id))})]})}),e.jsxs(p,{item:!0,xs:12,md:9,children:[y==="profile"&&e.jsxs(m,{children:[e.jsxs(k,{elevation:0,sx:{p:{xs:3,md:4},mb:3,borderRadius:2,border:"1px solid",borderColor:"divider"},children:[e.jsx(j,{variant:"h6",sx:{mb:3,fontWeight:600,color:"text.primary"},children:"Profile Picture"}),e.jsxs(p,{container:!0,spacing:3,children:[e.jsx(p,{item:!0,xs:12,sm:6,children:e.jsxs(m,{sx:{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",mb:{xs:3,sm:0}},children:[e.jsx(Q,{src:c,alt:v.firstName,sx:{width:120,height:120,border:"3px solid white",boxShadow:"0 4px 10px rgba(0,0,0,0.1)",mb:3}},`profile-avatar-${c}`),e.jsx(z,{variant:"outlined",startIcon:e.jsx(ce,{size:16}),onClick:A,color:"primary",sx:{borderRadius:2},children:"Upload New Photo"}),e.jsx("input",{type:"file",ref:C,style:{display:"none"},accept:"image/jpeg, image/png, image/gif",onChange:N}),s&&e.jsxs(m,{sx:{mt:2,width:"100%",maxWidth:200},children:[e.jsx(m,{sx:{height:6,borderRadius:3,bgcolor:Z(t.palette.primary.main,.2),overflow:"hidden"},children:e.jsx(m,{sx:{height:"100%",borderRadius:3,width:`${n}%`,bgcolor:"primary.main",transition:"width 0.3s ease-in-out"}})}),e.jsxs(j,{variant:"caption",sx:{display:"block",textAlign:"center",mt:1},children:["Uploading... ",n,"%"]})]})]})}),e.jsxs(p,{item:!0,xs:12,sm:6,children:[e.jsx(j,{variant:"subtitle2",sx:{mb:2,fontWeight:600},children:"Select Default Avatar"}),e.jsx(m,{sx:{display:"grid",gridTemplateColumns:"repeat(auto-fill, minmax(60px, 1fr))",gap:1.5},children:B.map(a=>e.jsxs(m,{onClick:()=>h(a.id),sx:{p:1,border:"2px solid",borderColor:R===a.id?"primary.main":Z("#000",.06),borderRadius:2,cursor:"pointer",position:"relative",transition:"all 0.2s ease","&:hover":{borderColor:Z(t.palette.primary.main,.5),transform:"translateY(-2px)",boxShadow:"0 4px 8px rgba(0,0,0,0.05)"}},children:[e.jsx(Q,{src:a.src,alt:a.alt,sx:{width:"100%",height:"auto",aspectRatio:"1/1"}}),R===a.id&&e.jsx(m,{sx:{position:"absolute",top:-8,right:-8,bgcolor:"primary.main",borderRadius:"50%",width:22,height:22,display:"flex",alignItems:"center",justifyContent:"center"},children:e.jsx(de,{size:14,color:"white"})})]},a.id))})]})]})]}),e.jsxs(k,{elevation:0,sx:{p:{xs:3,md:4},borderRadius:2,border:"1px solid",borderColor:"divider"},children:[e.jsx(j,{variant:"h6",sx:{mb:3,fontWeight:600,color:"text.primary"},children:"Personal Information"}),e.jsx("form",{onSubmit:x,children:e.jsxs(p,{container:!0,spacing:3,children:[e.jsx(p,{item:!0,xs:12,sm:6,children:e.jsx(U,{fullWidth:!0,label:"First Name",name:"firstName",value:v.firstName,onChange:f,required:!0,variant:"outlined",InputProps:{sx:{borderRadius:1.5}}})}),e.jsx(p,{item:!0,xs:12,sm:6,children:e.jsx(U,{fullWidth:!0,label:"Last Name",name:"lastName",value:v.lastName,onChange:f,required:!0,variant:"outlined",InputProps:{sx:{borderRadius:1.5}}})}),e.jsx(p,{item:!0,xs:12,sm:6,children:e.jsx(U,{fullWidth:!0,label:"Email",name:"email",type:"email",value:v.email,onChange:f,required:!0,variant:"outlined",disabled:!0,InputProps:{sx:{borderRadius:1.5,bgcolor:"action.disabledBackground","& .MuiInputBase-input.Mui-disabled":{WebkitTextFillColor:"text.secondary"}}},helperText:"Email cannot be changed"})}),e.jsx(p,{item:!0,xs:12,sm:6,children:e.jsxs(pe,{fullWidth:!0,variant:"outlined",children:[e.jsx(me,{id:"gender-label",children:"Gender"}),e.jsx(ge,{labelId:"gender-label",id:"gender",name:"gender",value:v.gender||"prefer-not-to-say",label:"Gender",onChange:f,sx:{borderRadius:1.5},children:fe.map(a=>e.jsx(ue,{value:a.value,children:a.label},a.value))})]})}),e.jsx(p,{item:!0,xs:12,children:e.jsx(m,{sx:{display:"flex",justifyContent:"flex-end",mt:2},children:e.jsx(z,{type:"submit",variant:"contained",color:"primary",size:"large",sx:{borderRadius:2,px:4},children:"Save Changes"})})})]})})]})]}),y==="security"&&e.jsxs(k,{elevation:0,sx:{p:{xs:3,md:4},borderRadius:2,border:"1px solid",borderColor:"divider"},children:[e.jsx(j,{variant:"h6",sx:{mb:3,fontWeight:600,color:"text.primary"},children:"Security Settings"}),q?e.jsx(m,{sx:{p:3,borderRadius:2,mb:3,bgcolor:"info.50",borderLeft:"4px solid",borderColor:"info.main"},children:e.jsxs(m,{sx:{display:"flex",alignItems:"flex-start"},children:[e.jsx(m,{sx:{mr:2,color:"info.main",display:"flex"},children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5",viewBox:"0 0 20 20",fill:"currentColor",children:e.jsx("path",{fillRule:"evenodd",d:"M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z",clipRule:"evenodd"})})}),e.jsx(j,{sx:{color:"info.dark"},children:"You signed in with Google. To change your password, please visit your Google account settings."})]})}):e.jsx("form",{onSubmit:M,children:e.jsxs(p,{container:!0,spacing:3,children:[e.jsx(p,{item:!0,xs:12,children:e.jsx(U,{fullWidth:!0,label:"Current Password",name:"currentPassword",type:"password",value:w.currentPassword,onChange:D,required:!0,variant:"outlined",InputProps:{sx:{borderRadius:1.5}}})}),e.jsx(p,{item:!0,xs:12,sm:6,children:e.jsx(U,{fullWidth:!0,label:"New Password",name:"newPassword",type:"password",value:w.newPassword,onChange:D,required:!0,helperText:"Must be at least 8 characters long",variant:"outlined",InputProps:{sx:{borderRadius:1.5}}})}),e.jsx(p,{item:!0,xs:12,sm:6,children:e.jsx(U,{fullWidth:!0,label:"Confirm New Password",name:"confirmPassword",type:"password",value:w.confirmPassword,onChange:D,required:!0,error:w.newPassword!==w.confirmPassword&&w.confirmPassword!=="",helperText:w.newPassword!==w.confirmPassword&&w.confirmPassword!==""?"Passwords don't match":"",variant:"outlined",InputProps:{sx:{borderRadius:1.5}}})}),e.jsx(p,{item:!0,xs:12,children:e.jsx(m,{sx:{display:"flex",justifyContent:"flex-end",mt:2},children:e.jsx(z,{type:"submit",variant:"contained",color:"primary",size:"large",sx:{borderRadius:2,px:4},children:"Update Password"})})})]})})]})]})]})})]})};export{Re as default};
