import{b as z,e as B,l as Y,u as q,r as i,R as M,j as e,p as b,U as V,t as k,v as W,w as H}from"./index-BN0NLy4X.js";import{A as K}from"./arrow-right-BbUIgDTy.js";const O=[{id:"avatar-1",src:"/avatars/1.svg",alt:"Avatar 1"},{id:"avatar-2",src:"/avatars/2.svg",alt:"Avatar 2"},{id:"avatar-3",src:"/avatars/3.svg",alt:"Avatar 3"},{id:"avatar-4",src:"/avatars/4.svg",alt:"Avatar 4"},{id:"avatar-5",src:"/avatars/5.svg",alt:"Avatar 5"},{id:"avatar-6",src:"/avatars/6.svg",alt:"Avatar 6"},{id:"default-avatar",src:" /avatars/7.svg",alt:"Default Avatar"}],Q=[{value:"male",label:"Male"},{value:"female",label:"Female"},{value:"non-binary",label:"Non-binary"},{value:"transgender",label:"Transgender"},{value:"other",label:"Other"},{value:"prefer-not-to-say",label:"Prefer not to say"}],ae=()=>{const y=z(),l=B(),{startLoading:R,stopLoading:F,isLoading:w}=Y(),{user:t,setUser:g}=q(),[u,P]=i.useState("prefer-not-to-say"),[j,U]=i.useState("default-avatar"),[m,N]=i.useState(!1),[I,h]=i.useState(0),[S,$]=i.useState(!1),[f,E]=i.useState(""),v=M.useRef(null);i.useEffect(()=>{var s;const a=localStorage.getItem("authToken"),o=localStorage.getItem("user");if(!a||!o){console.error("Missing authentication in onboarding"),l.error("Authentication error. Please try logging in again."),y("/login");return}console.log("Onboarding auth check:",{hasToken:!!a,hasUser:!!o,userId:(t==null?void 0:t.id)||((s=JSON.parse(o))==null?void 0:s.id)})},[]),i.useEffect(()=>{t&&(t.gender&&P(t.gender),t.avatar&&(t.avatar.includes("cloudinary.com")?(N(!0),E(t.avatar)):U(t.avatar)))},[t]);const L=()=>{var a;(a=v.current)==null||a.click()},D=async a=>{var o;try{const s=O.find(x=>x.id===a);if(!s)throw new Error("Selected avatar not found");let n=s.src;n.startsWith("/")&&(n=`${window.location.origin}${n}`),console.log("Fetching SVG from:",n);const r=await fetch(n);if(!r.ok)throw new Error(`Failed to fetch SVG: ${r.status}`);const T=await r.text(),c=`data:image/svg+xml;base64,${btoa(T)}`,A=`${(t==null?void 0:t.id)||((o=JSON.parse(localStorage.getItem("user")))==null?void 0:o.id)}_${Date.now()}`,p=await fetch("http://localhost:5000/api/upload/avatar/base64",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("authToken")}`},body:JSON.stringify({base64Image:c,avatarId:a,uniqueId:A})});if(!p.ok){const x=await p.json();throw new Error(x.message||`Server error: ${p.status}`)}const C=await p.json();if(!C.success)throw new Error(C.message||"Failed to upload default avatar");return C.avatar}catch(s){throw console.error("Error uploading default avatar:",s),s}},G=async a=>{var n;const o=(n=a.target.files)==null?void 0:n[0];if(!o)return;if(!["image/jpeg","image/png","image/gif","image/jpg"].includes(o.type)){l.error("Please select a valid image file (JPEG, PNG, GIF)");return}if(o.size>2*1024*1024){l.error("Image must be less than 2MB");return}$(!0),h(10);try{const r=new FormData;r.append("avatar",o),h(30);const c=await fetch("http://localhost:5000/api/uploads/avatar",{method:"POST",headers:{Authorization:`Bearer ${localStorage.getItem("authToken")}`},body:r});if(h(70),!c.ok){const A=await c.json();throw new Error(A.message||`Server error: ${c.status}`)}const d=await c.json();if(!d.success)throw new Error(d.message||"Failed to upload image");if(console.log("Avatar upload response:",d),!d.avatar)throw new Error("No avatar URL returned from server");E(d.avatar),N(!0),h(100),l.success("Avatar uploaded successfully!"),g&&t&&g({...t,avatar:d.avatar})}catch(r){console.error("Error uploading avatar:",r),l.error(r.message||"Failed to upload avatar")}finally{$(!1),v.current&&(v.current.value="")}},_=async()=>{R();try{let a;if(m&&f)a=f;else try{l.info("Processing avatar...",{autoClose:2e3}),a=await D(j)}catch(r){console.error("Failed to upload default avatar:",r),a=j,l.warning("Using default avatar due to upload issue",{autoClose:2e3})}console.log("Final avatar being saved:",a);const s=await fetch("http://localhost:5000/api/users/onboarding",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("authToken")}`},body:JSON.stringify({gender:u,avatar:a,hasCompletedOnboarding:!0}),credentials:"include"});if(!s.ok){const r=await s.json();throw new Error(r.message||`Server error: ${s.status}`)}const n=await s.json();if(g&&t){const r={...t,gender:u,avatar:a,hasCompletedOnboarding:!0};g(r),localStorage.setItem("user",JSON.stringify(r))}l.success("Profile updated successfully!"),setTimeout(()=>{y((t==null?void 0:t.role)==="admin"?"/admin/dashboard":"/dashboard")},800)}catch(a){console.error("Profile update error:",a),l.error(a.message||"Failed to update profile. Please try again.")}finally{F()}},J=()=>{l.info("You can update your profile later in the settings."),y((t==null?void 0:t.role)==="admin"?"/admin/dashboard":"/dashboard")};return e.jsx("div",{className:"min-h-screen bg-gray-50 flex flex-col items-center justify-center p-6",children:e.jsxs("div",{className:"w-full max-w-2xl bg-white rounded-2xl shadow-lg p-8",children:[e.jsxs("div",{className:"text-center mb-8",children:[e.jsx("div",{className:"flex justify-center mb-4",children:e.jsx("div",{className:"w-20 h-20 rounded-full flex items-center justify-center",style:{border:`2px solid ${b.main}`},children:e.jsx(V,{className:"w-10 h-10",style:{color:b.main}})})}),e.jsx("h1",{className:"text-3xl font-bold mb-2",style:{color:k.main},children:"Complete Your Profile"}),e.jsx("p",{className:"text-gray-600 text-lg max-w-lg mx-auto",children:"Personalize your EcoPulse experience by setting up your profile. This helps us provide a more tailored experience."})]}),e.jsxs("div",{className:"mb-8",children:[e.jsx("h2",{className:"font-semibold text-xl mb-4",style:{color:k.main},children:"Choose Your Gender"}),e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-3 gap-3",children:Q.map(a=>e.jsx("button",{type:"button",className:`py-4 px-3 rounded-xl border-2 transition-all ${u===a.value?"border-green-600 bg-green-50 shadow-md":"border-gray-200 hover:border-gray-300 hover:bg-gray-50"}`,onClick:()=>P(a.value),children:e.jsxs("div",{className:"flex items-center",children:[u===a.value&&e.jsx(W,{className:"w-5 h-5 text-green-600 mr-2"}),e.jsx("span",{className:`${u===a.value?"font-medium":""}`,children:a.label})]})},a.value))})]}),e.jsxs("div",{className:"mb-10",children:[e.jsx("h2",{className:"font-semibold text-xl mb-4",style:{color:k.main},children:"Choose Your Avatar"}),e.jsxs("div",{className:"grid grid-cols-4 gap-4",children:[O.map(a=>e.jsx("button",{type:"button",className:`p-3 rounded-xl border-2 transition-all ${!m&&j===a.id?"border-green-600 bg-green-50 shadow-md":"border-gray-200 hover:border-gray-300 hover:bg-gray-50"}`,onClick:()=>{U(a.id),N(!1)},children:e.jsx("img",{src:a.src,alt:a.alt,className:"w-full h-auto rounded-lg"})},a.id)),e.jsx("button",{type:"button",className:`p-3 rounded-xl border-2 transition-all ${m?"border-green-600 bg-green-50 shadow-md":"border-gray-200 hover:border-gray-300 hover:bg-gray-50"}`,onClick:L,children:m&&f?e.jsx("img",{src:f,alt:"Custom Avatar",className:"w-full h-auto aspect-square object-cover rounded-lg"}):e.jsxs("div",{className:"flex flex-col items-center justify-center h-full aspect-square bg-gray-100 rounded-lg",children:[e.jsx(H,{className:"w-8 h-8 mb-2 text-gray-400"}),e.jsx("span",{className:"text-xs text-gray-500",children:"Upload"})]})}),e.jsx("input",{type:"file",ref:v,className:"hidden",accept:"image/jpeg, image/png, image/gif",onChange:G})]}),S&&e.jsxs("div",{className:"mt-4",children:[e.jsx("div",{className:"w-full bg-gray-200 rounded-full h-2.5",children:e.jsx("div",{className:"bg-green-600 h-2.5 rounded-full",style:{width:`${I}%`}})}),e.jsxs("p",{className:"text-sm text-gray-500 text-center mt-2",children:["Uploading... ",I,"%"]})]}),e.jsx("p",{className:"text-sm text-gray-500 mt-4 text-center",children:"You can change your avatar anytime from your profile settings."})]}),e.jsxs("div",{className:"flex flex-col space-y-3",children:[e.jsx("button",{type:"button",onClick:_,disabled:w||S,className:"w-full py-3 flex items-center justify-center bg-green-600 text-white rounded-xl font-medium hover:bg-green-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed",style:{backgroundColor:b.main,borderColor:b.main},children:w?"Saving...":e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"text-lg",children:"Complete & Continue"}),e.jsx(K,{className:"w-5 h-5 ml-2"})]})}),e.jsx("button",{type:"button",onClick:J,disabled:w||S,className:"w-full py-2 text-gray-600 hover:text-gray-800 transition-colors text-sm",children:"Skip for now"})]})]})})};export{ae as default};
