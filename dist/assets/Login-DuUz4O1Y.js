import{u as T,b as Y,d as O,e as U,r as m,f as x,j as e,L as W,p as A,U as M,t as B,g as J,h as P,i as E,M as z}from"./index-D-CDyacC.js";import{c as H,a as D,F as K,b as Q,d as V,E as C,L as X}from"./index.esm-11jg-Cex.js";import{c as Z}from"./crosswalk-C791ooMc.js";import{R as _}from"./refresh-cw-BS07gTpP.js";const ee=()=>{const{login:S,googleSignIn:I,setUser:f,setIsAuthenticated:p}=T(),i=Y();O();const r=U(),[c,g]=m.useState(!1),[h,n]=m.useState(null),[d,v]=m.useState(""),[R,b]=m.useState(!1),[u,y]=m.useState(!1),[w,L]=m.useState(null),j=()=>g(!0),o=()=>g(!1),q=s=>{n(null),r.success(`Welcome back, ${s.firstName||"User"}!`)},N=s=>{console.error("Auth error:",s),n(s.message),r.error(s.message||"Authentication failed")},G=async s=>{console.log("Handling auto-deactivated account:",s),y(!0),v(s),r.info("Your account has been automatically deactivated due to inactivity. A reactivation link has been sent to your email.");try{console.log("Sending reactivation email..."),(await x.requestReactivation(s)).success?i("/reactivate-account",{state:{email:s,isAutoDeactivated:!0,message:"Your account has been automatically deactivated due to inactivity. A reactivation link has been sent to your email."},replace:!0}):i("/reactivate-account",{state:{email:s,isAutoDeactivated:!0,hasError:!0,message:"We encountered an issue sending the reactivation email. Please try requesting a new one."},replace:!0})}catch(a){console.error("Error in auto-deactivated account flow:",a),i("/reactivate-account",{state:{email:s,isAutoDeactivated:!0,hasError:!0,message:"We encountered an issue sending the reactivation email. Please try requesting a new one."},replace:!0})}},$=H({email:D().email("Invalid email format").required("Email is required"),password:D().required("Password is required")});return{isLoading:c,authError:h,handleSubmit:async(s,{setSubmitting:a})=>{console.log("Login attempt:",{email:s.email}),a(!0),n(null),j();try{const l=await x.checkAccountStatus(s.email);if(console.log("Account status check result:",l),l.exists&&l.isAutoDeactivated){console.log("Account is auto-deactivated:",l),L({email:s.email,deactivatedAt:l.deactivatedAt,tokenExpired:l.tokenExpired}),await G(s.email),a(!1),o();return}const t=await S(s.email,s.password);if(console.log("Login result:",t),t&&t.wasReactivated){if(console.log("Account was automatically reactivated during login:",t),r.success("Your account has been reactivated. Welcome back!"),!t.user){r.error("Invalid response from server"),a(!1),o();return}localStorage.setItem("user",JSON.stringify(t.user)),t.user.accessToken&&localStorage.setItem("authToken",t.user.accessToken),f(t.user),p(!0),q(t.user),t.user.role==="admin"?i("/admin/dashboard",{replace:!0}):i("/dashboard",{replace:!0}),a(!1),o();return}if(!t||!t.success){const F=(t==null?void 0:t.message)||"Login failed. Please try again.";r.error(F),a(!1),o();return}if(!t.user){r.error("Invalid response from server"),a(!1),o();return}if(console.log("Checking verification status:",{userEmail:t.user.email,explicitVerification:!!t.isVerified,userVerification:!!t.user.isVerified,requireVerification:!!t.requireVerification}),t.requireVerification===!0){console.log("Server explicitly requires verification"),i("/verify-email",{state:{userId:t.user.id||t.userId,email:s.email}}),a(!1),o();return}console.log("User considered verified, proceeding with login");const k={...t.user,isVerified:!0};localStorage.setItem("user",JSON.stringify(k)),t.user.accessToken&&localStorage.setItem("authToken",t.user.accessToken),f(k),p(!0),q(k),k.role==="admin"?i("/admin/dashboard",{replace:!0}):i("/dashboard",{replace:!0})}catch(l){console.error("Login submission error:",l),N(l)}finally{a(!1),o()}},handleGoogleSignIn:async()=>{try{n(null),b(!1),j(),console.log("Starting Google sign-in attempt");const s=await I();if(console.log("Google sign-in result received:",s),s&&s.email){const a=await x.checkAccountStatus(s.email);if(console.log("Account status check result:",a),a.exists&&a.isAutoDeactivated){console.log("Account is auto-deactivated:",a),L({email:s.email,deactivatedAt:a.deactivatedAt,tokenExpired:a.tokenExpired}),await G(s.email),o();return}}if(s&&s.requireVerification){console.log("Account requires verification:",s),i("/verify-email",{state:{userId:s.userId,email:s.email||""}}),r.info(s.message||"Please verify your email to complete sign-in."),o();return}if(s&&s.success)r.success("Google sign-in successful");else throw new Error((s==null?void 0:s.message)||"Google sign-in failed")}catch(s){console.error("Google sign-in error:",s),s.code==="auth/popup-closed-by-user"?(r.info("Sign-in was cancelled"),n("Sign-in was cancelled. Please try again.")):s.code==="auth/popup-blocked"?(r.error("Sign-in popup was blocked. Please try again or use redirect sign-in."),n("Browser blocked the popup. Please enable popups or use redirect sign-in."),b(!0)):N(s)}finally{o()}},handleGoogleRedirectSignIn:async()=>{try{n(null),j(),r.info("Redirecting to Google sign-in..."),await x.googleSignInWithRedirect()}catch(s){console.error("Google redirect sign-in error:",s),N(s),o()}},showRedirectOption:R,initialValues:{email:"",password:""},validationSchema:$,isAutoDeactivated:u,recoveryEmail:d,setRecoveryEmail:v,handleRequestReactivation:async()=>{if(!d){r.error("Email is required");return}j();try{const s=await x.requestReactivation(d);s.success?(r.success("Reactivation email sent. Please check your inbox and follow the instructions."),i("/reactivate-account",{state:{email:d,isAutoDeactivated:!0,message:"A reactivation link has been sent to your email."},replace:!0})):r.error(s.message||"Failed to send reactivation email")}catch(s){N(s)}finally{o()}},deactivationInfo:w}},de=()=>{const{handleGoogleSignIn:S,handleGoogleRedirectSignIn:I,showRedirectOption:f,handleSubmit:p,initialValues:i,validationSchema:r,isLoading:c,authError:g,isDeactivated:h,showReactivationOption:n,lockoutInfo:d,recoveryEmail:v,setRecoveryEmail:R,handleRequestReactivation:b}=ee();return e.jsxs(e.Fragment,{children:[c&&e.jsx(W,{}),e.jsxs("div",{className:"flex min-h-screen",children:[e.jsxs("div",{className:"flex flex-col items-center justify-center flex-1 p-12 text-center",style:{background:`linear-gradient(135deg, ${A.main}, ${A.dark})`},children:[e.jsx("img",{src:"/logo.png",alt:"EcoPulse Logo",className:"w-32 h-32 mb-6"}),e.jsx("h1",{className:"mb-6 text-5xl font-bold text-white",children:"EcoPulse"}),e.jsx("p",{className:"text-lg leading-relaxed text-white/80 max-w-md",children:"Join our community of eco-conscious individuals and businesses. Together, we can make a difference for a sustainable future."})]}),e.jsxs("div",{className:"relative flex items-center justify-center w-1/2 bg-center bg-cover",style:{backgroundImage:`url(${Z})`,backgroundSize:"cover",backgroundPosition:"center"},children:[e.jsx("div",{className:"absolute inset-0",style:{backgroundColor:"rgba(255, 255, 255, 0.9)"}}),e.jsxs("div",{className:"relative z-10 w-full max-w-md p-8 mx-12 bg-white shadow-xl rounded-3xl",children:[e.jsx("div",{className:"flex justify-center mb-4",children:e.jsx("div",{className:"w-16 h-16 rounded-full flex items-center justify-center",style:{border:`2px solid ${A.main}`},children:e.jsx(M,{className:"w-8 h-8",style:{color:A.main}})})}),e.jsx("h2",{className:"mb-6 text-2xl font-bold text-center",style:{color:B.main},children:h?"Account Deactivated":"Login"}),h&&e.jsxs("div",{className:"space-y-6",children:[d&&e.jsxs("div",{className:"p-4 bg-yellow-50 border border-yellow-200 rounded-lg space-y-3",children:[e.jsxs("div",{className:"flex items-center space-x-2 text-yellow-800",children:[e.jsx(J,{className:"w-5 h-5"}),e.jsx("h3",{className:"font-medium",children:"Reactivation Locked"})]}),e.jsxs("p",{className:"text-sm text-yellow-700",children:["Your account reactivation is currently locked. Please try again in ",d.hours," hours."]})]}),n&&e.jsxs("div",{className:"p-4 bg-green-50 border border-green-200 rounded-lg space-y-3",children:[e.jsxs("div",{className:"flex items-center space-x-2 text-green-800",children:[e.jsx(P,{className:"w-5 h-5"}),e.jsx("h3",{className:"font-medium",children:"Account Deactivated"})]}),e.jsx("p",{className:"text-sm text-green-700",children:"Your account has been deactivated. A reactivation link has been sent to your email."}),e.jsxs("div",{className:"space-y-2 pt-2",children:[e.jsx("p",{className:"text-sm font-medium text-gray-700",children:"Didn't receive the email? Request a new reactivation link:"}),e.jsxs("div",{className:"flex space-x-2",children:[e.jsx("input",{type:"email",value:v,onChange:u=>R(u.target.value),placeholder:"Your email",className:"flex-1 h-10 px-3 border rounded-lg text-sm"}),e.jsxs("button",{onClick:b,disabled:c,className:"h-10 px-4 bg-green-700 text-white rounded-lg font-medium hover:bg-green-800 transition-colors disabled:opacity-50 disabled:cursor-not-allowed text-sm flex items-center",children:[e.jsx(_,{className:"w-4 h-4 mr-2"}),"Send"]})]})]})]}),e.jsx("div",{className:"pt-4",children:e.jsx(E,{to:"/login",className:"w-full h-10 flex items-center justify-center bg-gray-200 text-gray-800 rounded-lg font-medium hover:bg-gray-300 transition-colors text-sm",children:"Back to Login"})})]}),!h&&e.jsx(e.Fragment,{children:e.jsx(K,{initialValues:i,validationSchema:r,onSubmit:p,children:({isSubmitting:u,touched:y,errors:w})=>e.jsxs(Q,{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"relative flex items-center",children:[e.jsx(z,{className:"absolute left-3 w-4 h-4 text-gray-400"}),e.jsx(V,{type:"email",name:"email",className:`w-full h-10 pl-9 pr-3 border rounded-lg text-sm ${y.email&&w.email?"border-red-500":"border-gray-300"}`,placeholder:"Email"})]}),e.jsx(C,{name:"email",component:"div",className:"text-xs text-red-500"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"relative flex items-center",children:[e.jsx(X,{className:"absolute left-3 w-4 h-4 text-gray-400"}),e.jsx(V,{type:"password",name:"password",className:`w-full h-10 pl-9 pr-3 border rounded-lg text-sm ${y.password&&w.password?"border-red-500":"border-gray-300"}`,placeholder:"Password"})]}),e.jsx(C,{name:"password",component:"div",className:"text-xs text-red-500"})]}),e.jsx("div",{className:"text-right",children:e.jsx(E,{to:"/forgot-password",className:"text-xs text-green-700 hover:underline",children:"Forgot password?"})}),e.jsx("button",{type:"submit",disabled:u||c,className:"w-full h-10 bg-green-700 text-white rounded-lg font-medium hover:bg-green-800 transition-colors disabled:opacity-50 disabled:cursor-not-allowed text-sm",children:u||c?"Logging in...":"Login"}),e.jsxs("div",{className:"relative py-2",children:[e.jsx("div",{className:"absolute inset-0 flex items-center",children:e.jsx("div",{className:"w-full border-t border-gray-300"})}),e.jsx("div",{className:"relative flex justify-center",children:e.jsx("span",{className:"px-4 text-xs text-gray-500 bg-white",children:"Or continue with"})})]}),e.jsxs("button",{type:"button",onClick:S,disabled:c,className:"w-full h-10 flex items-center justify-center gap-2 border border-gray-300 rounded-lg text-gray-700 font-medium hover:bg-gray-50 transition-colors disabled:opacity-50 disabled:cursor-not-allowed text-sm",children:[e.jsx("img",{src:"/google.svg",alt:"Google",className:"w-4 h-4"}),e.jsx("span",{children:"Sign in with Google"})]}),f&&e.jsxs("div",{className:"mt-4 p-4 bg-blue-50 border border-blue-200 rounded-lg space-y-3",children:[e.jsxs("div",{className:"flex items-center space-x-2 text-blue-800",children:[e.jsx(P,{className:"w-5 h-5"}),e.jsx("h3",{className:"font-medium",children:"Popup Blocked"})]}),e.jsx("p",{className:"text-sm text-blue-700",children:"Your browser blocked the sign-in popup. You can enable popups in your browser settings or use the redirect method instead."}),e.jsxs("button",{type:"button",onClick:I,disabled:c,className:"w-full h-10 flex items-center justify-center gap-2 bg-blue-700 text-white rounded-lg font-medium hover:bg-blue-800 transition-colors disabled:opacity-50 disabled:cursor-not-allowed text-sm",children:[e.jsx("img",{src:"/google.svg",alt:"Google",className:"w-4 h-4 invert"}),e.jsx("span",{children:"Sign in with Google (Redirect)"})]})]}),g&&e.jsx("div",{className:"p-3 bg-red-50 border border-red-200 rounded-lg text-sm text-red-700",children:g}),e.jsxs("div",{className:"text-center text-xs text-gray-600",children:["Not a member?"," ",e.jsx(E,{to:"/register",className:"font-medium text-green-700 hover:underline",children:"Sign up now"})]})]})})})]})]})]})]})};export{de as default};
