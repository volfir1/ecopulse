import{r as x,e as D,Z as $,af as W,j as e,B as a,L as B,a2 as d,T as i,a3 as b,o as R,E,a8 as w,ag as N,ah as U,V as z}from"./index-CeiZKB8G.js";import{t as v}from"./ticketService-PgP5Vb-h.js";import{g as F,a as M,b as L,c as P,f as S,d as A,i as G,e as _}from"./userTicketUtils-Bb_iHy91.js";import{C as I}from"./Chip-D2qSxnvf.js";import"./index-CSy9Y5X6.js";const q=r=>{const[l,t]=x.useState(null),[C,p]=x.useState(!0),[f,h]=x.useState(null),[u,j]=x.useState(""),{showSnackbar:o}=D(),{user:m}=x.useContext($),y=x.useCallback(async()=>{if(!r){h("Invalid ticket ID"),p(!1);return}p(!0);try{console.log(`Fetching ticket conversation for ticket ID: ${r}`);const s=await v.getTicket(r);if(console.log("Ticket API response:",s),s.success){const n=s.data;console.log("Ticket data to be set:",n),t(n)}else{const n=s.message||"Failed to load ticket details";console.error(n),h(n),o(n,"error")}}catch(s){console.error("Error fetching ticket:",s);const n=s.message||"Error loading ticket";h(n),o(n,"error")}finally{p(!1)}},[r,o]),T=async()=>{if(!u.trim()){o("Reply content cannot be empty","warning");return}try{console.log(`Sending reply to ticket ${r}:`,u);const s=await v.replyToTicket(r,u);s.success?(t(s.data),j(""),o("Reply sent successfully","success")):o(s.message||"Failed to send reply","error")}catch(s){console.error("Error sending reply:",s),o(s.message||"Failed to send reply","error")}},k=async()=>{try{console.log(`Marking ticket ${r} as resolved`);const s=await v.updateTicketStatus(r,"resolved");s.success?(t(s.data),o("Ticket marked as resolved","success")):o(s.message||"Failed to update ticket status","error")}catch(s){console.error("Error updating ticket status:",s),o(s.message||"Failed to update ticket status","error")}},c=async s=>{if(!m||m.role!=="admin"){o("Not authorized to update ticket status","error");return}try{console.log(`Updating ticket ${r} status to ${s}`);const n=await v.updateTicketStatus(r,s);n.success?(t(n.data),o(`Ticket ${s} successfully`,"success")):o(n.message||"Failed to update ticket status","error")}catch(n){console.error("Error updating ticket status:",n),o(n.message||"Failed to update ticket status","error")}};return x.useEffect(()=>{y()},[y]),{ticket:l,loading:C,error:f,replyContent:u,setReplyContent:j,sendReply:T,markAsResolved:k,updateTicketStatus:c,refreshTicket:y}},H=N(z)(({theme:r,isCurrentUser:l,isAdmin:t})=>({padding:r.spacing(2),marginBottom:r.spacing(2),maxWidth:"80%",borderRadius:r.spacing(1.5),position:"relative",...l?{backgroundColor:r.palette.primary.light,color:r.palette.primary.contrastText,alignSelf:"flex-end"}:t?{backgroundColor:r.palette.secondary.light,color:r.palette.secondary.contrastText,alignSelf:"flex-start"}:{backgroundColor:r.palette.background.default,alignSelf:"flex-start"}})),V=N(a)({display:"flex",flexDirection:"column",gap:"8px",marginBottom:"16px"}),Y=N(a)(({theme:r})=>({display:"flex",flexDirection:"column",gap:r.spacing(2),padding:r.spacing(2),borderTop:`1px solid ${r.palette.divider}`})),X=()=>{const{ticketId:r}=W(),{user:l}=x.useContext($),{ticket:t,loading:C,error:p,replyContent:f,setReplyContent:h,sendReply:u,updateTicketStatus:j}=q(r);if(C)return e.jsx(a,{sx:{display:"flex",justifyContent:"center",alignItems:"center",height:"calc(100vh - 200px)"},children:e.jsx(B,{})});if(p)return e.jsxs(a,{sx:{display:"flex",flexDirection:"column",justifyContent:"center",alignItems:"center",height:"calc(100vh - 200px)",gap:2},children:[e.jsx(d,{name:"alert-triangle",size:40,color:"error"}),e.jsx(i,{color:"error",variant:"h6",children:p}),e.jsx(b,{variant:"outlined",onClick:()=>window.history.back(),startIcon:e.jsx(d,{name:"arrow-left"}),children:"Go Back"})]});if(!t)return e.jsxs(a,{sx:{display:"flex",flexDirection:"column",justifyContent:"center",alignItems:"center",height:"calc(100vh - 200px)",gap:2},children:[e.jsx(d,{name:"file-question",size:40}),e.jsx(i,{variant:"h6",children:"Ticket not found"}),e.jsx(b,{variant:"outlined",onClick:()=>window.history.back(),startIcon:e.jsx(d,{name:"arrow-left"}),children:"Go Back"})]});const o=(l==null?void 0:l.role)==="admin",m=F(t.status);M(t.status);const{color:y}=L(t.priority||"medium"),T=P(t.ticketNumber);l&&!o&&t.status;const k=l&&["open","in-progress"].includes(t.status);return e.jsxs(a,{sx:{width:"100%",maxWidth:900,mx:"auto",py:3,px:2},children:[e.jsx(R.Base,{variant:m,elevation:3,sx:{mb:3},children:e.jsxs(a,{sx:{p:2},children:[e.jsxs(a,{display:"flex",alignItems:"center",justifyContent:"space-between",mb:2,flexWrap:"wrap",gap:1,children:[e.jsxs(a,{display:"flex",alignItems:"center",gap:1,children:[e.jsx(d,{name:"ticket",size:20}),e.jsxs(i,{variant:"h6",fontWeight:"bold",children:[T,": ",t.subject]})]}),e.jsx(I,{label:t.status.toUpperCase(),color:m,size:"small"})]}),e.jsx(E,{sx:{my:2}}),e.jsxs(a,{display:"flex",flexWrap:"wrap",gap:3,justifyContent:"space-between",children:[e.jsxs(a,{minWidth:"120px",children:[e.jsx(i,{variant:"body2",color:"text.secondary",children:"Category"}),e.jsx(i,{variant:"body1",children:t.category||"General"})]}),e.jsxs(a,{minWidth:"120px",children:[e.jsx(i,{variant:"body2",color:"text.secondary",children:"Priority"}),e.jsx(I,{label:(t.priority||"Medium").toUpperCase(),color:y,size:"small"})]}),e.jsxs(a,{minWidth:"150px",children:[e.jsx(i,{variant:"body2",color:"text.secondary",children:"Created"}),e.jsx(i,{variant:"body1",children:S(t.createdAt)})]}),e.jsxs(a,{minWidth:"150px",children:[e.jsx(i,{variant:"body2",color:"text.secondary",children:"Last Updated"}),e.jsx(i,{variant:"body1",children:S(t.updatedAt)})]})]}),o&&t.assignedTo&&e.jsxs(a,{mt:2,children:[e.jsx(i,{variant:"body2",color:"text.secondary",children:"Assigned To"}),e.jsxs(a,{display:"flex",alignItems:"center",gap:1,children:[e.jsx(w,{sx:{width:24,height:24},children:A(`${t.assignedTo.firstName||""} ${t.assignedTo.lastName||""}`)}),e.jsxs(i,{children:[t.assignedTo.firstName," ",t.assignedTo.lastName]})]})]})]})}),e.jsx(R.Base,{elevation:2,sx:{mb:3},children:e.jsxs(a,{sx:{p:2},children:[e.jsx(i,{variant:"h6",mb:2,children:"Conversation"}),e.jsx(a,{sx:{display:"flex",flexDirection:"column",gap:3,height:"400px",maxHeight:"50vh",overflowY:"auto",p:1},children:t.messages&&t.messages.length>0?t.messages.map((c,s)=>{const n=G(c,l==null?void 0:l._id);let g="Unknown User";return n?g=`${l.firstName} ${l.lastName}`:c.isAdmin?g="Support Agent":t.user&&(g=`${t.user.firstName||""} ${t.user.lastName||""}`.trim()||"User"),e.jsxs(V,{children:[e.jsxs(a,{display:"flex",alignItems:"center",justifyContent:n?"flex-end":"flex-start",gap:1,mb:1,children:[!n&&e.jsx(w,{sx:{width:32,height:32},children:A(g)}),e.jsxs(i,{variant:"body2",color:"text.secondary",children:[g," â€¢ ",S(c.createdAt)]}),c.isAdmin&&e.jsx(I,{label:"Staff",size:"small",color:"secondary"}),n&&e.jsx(w,{sx:{width:32,height:32},children:A(g)})]}),e.jsx(H,{isCurrentUser:n,isAdmin:c.isAdmin,elevation:1,children:e.jsx(i,{variant:"body1",dangerouslySetInnerHTML:{__html:_(c.content)}})})]},s)}):e.jsxs(a,{sx:{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",height:"100%",opacity:.7},children:[e.jsx(d,{name:"message-square",size:40}),e.jsx(i,{variant:"body1",mt:1,children:"No messages yet"})]})}),k&&e.jsxs(Y,{children:[e.jsx(U,{rows:4,placeholder:"Type your reply here...",value:f,onChange:c=>h(c.target.value),fullWidth:!0,variant:"outlined"}),e.jsx(a,{display:"flex",justifyContent:"space-between",alignItems:"center",flexWrap:"wrap",gap:2,children:e.jsx(a,{ml:"auto",children:e.jsx(b,{variant:"contained",color:"primary",startIcon:e.jsx(d,{name:"send"}),onClick:u,disabled:!f.trim(),children:"Send Reply"})})})]}),!k&&e.jsxs(a,{textAlign:"center",p:3,bgcolor:"background.paper",borderRadius:1,border:1,borderColor:"divider",children:[e.jsxs(i,{variant:"h6",color:"text.secondary",mt:1,children:["This ticket is ",t.status==="closed"?"closed":"resolved"]}),t.status==="resolved"&&o&&e.jsx(b,{variant:"outlined",color:"primary",size:"small",startIcon:e.jsx(d,{name:"lock"}),onClick:()=>j("closed"),sx:{mt:2},children:"Close Ticket"})]})]})})]})};export{X as default};
