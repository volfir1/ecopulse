import{u as K,b as Q,d as X,e as Z,r as m,f as l,j as t,L as _,p as j,U as ee,t as te,g as se,h as $,i as G,M as ae}from"./index-BN0NLy4X.js";import{c as ie,a as C,F as re,b as oe,d as T,E as U,L as ne}from"./index.esm-DjrnaFrv.js";import{c as ce}from"./crosswalk-C791ooMc.js";import{R as le}from"./refresh-cw-CWf_GyjV.js";const de=()=>{const{login:N,googleSignIn:k,setUser:S,setIsAuthenticated:A}=K(),d=Q();X();const a=Z(),[n,g]=m.useState(!1),[h,o]=m.useState(null),[c,x]=m.useState(""),[R,v]=m.useState(!1),[u,f]=m.useState(!1),[p,q]=m.useState(null),Y=ie({email:C().email("Invalid email format").required("Email is required"),password:C().required("Password is required")}),O={email:"",password:""},b=()=>g(!0),y=()=>g(!1),W=e=>{a.success(`Welcome back, ${e.firstName||"User"}!`)},I=(e,s)=>{const r={...e,isVerified:!0};return localStorage.setItem("user",JSON.stringify(r)),e.accessToken&&localStorage.setItem("authToken",e.accessToken),S(r),A(!0),r},L=e=>{const s=e.role==="admin"?"/admin/dashboard":"/dashboard";d(s,{replace:!0})},w=(e,s=!1)=>{d("/reactivate-account",{state:{email:e,isAutoDeactivated:!0,hasError:s,message:s?"We encountered an issue sending the reactivation email. Please try requesting a new one.":"A reactivation link has been sent to your email."},replace:!0})},D=e=>{d("/login",{state:{email:e,isAutoDeactivated:!0,message:"Your account has been automatically deactivated due to inactivity. A reactivation link has been sent to your email."},replace:!0})},M=async e=>{console.log("Handling auto-deactivated account:",e),f(!0),x(e),a.info("Your account has been automatically deactivated due to inactivity. A reactivation link has been sent to your email.");try{console.log("Sending reactivation email..."),(await l.requestReactivation(e)).success?D(e):w(e,!0)}catch(s){console.error("Error in auto-deactivated account flow:",s),w(e,!0)}},z=async(e,s)=>{q({email:e,deactivatedAt:s.deactivatedAt,tokenExpired:s.tokenExpired}),f(!0),x(e),a.info("Account deactivated due to inactivity. Reactivation link sent."),(await l.requestReactivation(e)).success?D(e):w(e,!0)},P=async e=>{if(!e.user){a.error("Invalid server response");return}const s=I(e.user);a.success("Account reactivated. Welcome back!"),L(s)},B=async()=>{if(!c){a.error("Email is required");return}b();try{const e=await l.requestReactivation(c);e.success?(a.success("Reactivation email sent. Please check your inbox and follow the instructions."),w(c)):a.error(e.message||"Failed to send reactivation email")}catch(e){console.error("Reactivation request error:",e),o(e.message||"Failed to request reactivation"),a.error(e.message||"Failed to request reactivation")}finally{y()}},V=e=>{d("/verify-email",{state:{userId:e.userId,email:e.email||""}}),a.info(e.message||"Please verify your email")},J=async e=>{if(!e.user){a.error("Invalid user data received");return}const s=I(e.user);a.success(`Welcome, ${s.firstName||"User"}!`),L(s)},H=e=>{console.error("Google sign-in error handler:",e);let s=e.message||"Google sign-in failed";e.code==="auth/popup-closed-by-user"?(s="Sign-in process was cancelled",a.info("Sign-in cancelled")):e.code==="auth/popup-blocked"&&(s="Popup blocked - try direct redirect",a.error("Enable popups or use email sign-in"),v(!0)),o(s),["auth/popup-closed-by-user","auth/popup-blocked"].includes(e.code)||a.error(s)};return{isLoading:n,authError:h,handleSubmit:async(e,{setSubmitting:s})=>{console.log("Login attempt:",{email:e.email}),s(!0),o(null),b();try{const r=await l.checkAccountStatus(e.email);if(console.log("Account status check result:",r),r.exists&&r.isAutoDeactivated){console.log("Account is auto-deactivated:",r),q({email:e.email,deactivatedAt:r.deactivatedAt,tokenExpired:r.tokenExpired});try{await l.login(e.email,e.password)}catch(E){console.log("Login attempt on deactivated account (for notification):",E.message)}await M(e.email);return}const i=await N(e.email,e.password);if(console.log("Login result:",i),i&&i.wasReactivated){await P(i);return}if(!i||!i.success){const E=(i==null?void 0:i.message)||"Login failed. Please try again.";a.error(E);return}if(!i.user){a.error("Invalid response from server");return}if(console.log("Checking verification status:",{userEmail:i.user.email,explicitVerification:!!i.isVerified,userVerification:!!i.user.isVerified,requireVerification:!!i.requireVerification}),i.requireVerification===!0){console.log("Server explicitly requires verification"),V({userId:i.user.id||i.userId,email:e.email,message:i.message});return}console.log("User considered verified, proceeding with login");const F=I(i.user);W(F),L(F)}catch(r){console.error("Login submission error:",r),o(r.message||"Authentication failed"),a.error(r.message||"Authentication failed")}finally{s(!1),y()}},handleGoogleSignIn:async()=>{try{o(null),v(!1),b(),console.log("Starting Google sign-in attempt");const e=await k();if(console.log("Google sign-in result received:",e),e&&e.email){const s=await l.checkAccountStatus(e.email);if(console.log("Account status check result:",s),s.exists&&s.isAutoDeactivated){await z(e.email,s);return}if(e.wasReactivated){await P(e);return}}if(e!=null&&e.requireVerification){V(e);return}if(e!=null&&e.success){await J(e);return}throw new Error((e==null?void 0:e.message)||"Google authentication failed")}catch(e){console.error("Google sign-in error:",e),H(e)}finally{y()}},handleGoogleRedirectSignIn:async()=>{try{o(null),b(),a.info("Redirecting to Google sign-in..."),await l.googleSignInWithRedirect()}catch(e){console.error("Google redirect sign-in error:",e),o(e.message||"Google sign-in redirect failed"),a.error(e.message||"Google sign-in redirect failed"),y()}},showRedirectOption:R,initialValues:O,validationSchema:Y,isAutoDeactivated:u,recoveryEmail:c,setRecoveryEmail:x,handleRequestReactivation:B,deactivationInfo:p}},pe=()=>{const{handleGoogleSignIn:N,handleGoogleRedirectSignIn:k,showRedirectOption:S,handleSubmit:A,initialValues:d,validationSchema:a,isLoading:n,authError:g,isDeactivated:h,showReactivationOption:o,lockoutInfo:c,recoveryEmail:x,setRecoveryEmail:R,handleRequestReactivation:v}=de();return t.jsxs(t.Fragment,{children:[n&&t.jsx(_,{}),t.jsxs("div",{className:"flex min-h-screen",children:[t.jsxs("div",{className:"flex flex-col items-center justify-center flex-1 p-12 text-center",style:{background:`linear-gradient(135deg, ${j.main}, ${j.dark})`},children:[t.jsx("img",{src:"/logo.png",alt:"EcoPulse Logo",className:"w-32 h-32 mb-6"}),t.jsx("h1",{className:"mb-6 text-5xl font-bold text-white",children:"EcoPulse"}),t.jsx("p",{className:"text-lg leading-relaxed text-white/80 max-w-md",children:"Join our community of eco-conscious individuals and businesses. Together, we can make a difference for a sustainable future."})]}),t.jsxs("div",{className:"relative flex items-center justify-center w-1/2 bg-center bg-cover",style:{backgroundImage:`url(${ce})`,backgroundSize:"cover",backgroundPosition:"center"},children:[t.jsx("div",{className:"absolute inset-0",style:{backgroundColor:"rgba(255, 255, 255, 0.9)"}}),t.jsxs("div",{className:"relative z-10 w-full max-w-md p-8 mx-12 bg-white shadow-xl rounded-3xl",children:[t.jsx("div",{className:"flex justify-center mb-4",children:t.jsx("div",{className:"w-16 h-16 rounded-full flex items-center justify-center",style:{border:`2px solid ${j.main}`},children:t.jsx(ee,{className:"w-8 h-8",style:{color:j.main}})})}),t.jsx("h2",{className:"mb-6 text-2xl font-bold text-center",style:{color:te.main},children:h?"Account Deactivated":"Login"}),h&&t.jsxs("div",{className:"space-y-6",children:[c&&t.jsxs("div",{className:"p-4 bg-yellow-50 border border-yellow-200 rounded-lg space-y-3",children:[t.jsxs("div",{className:"flex items-center space-x-2 text-yellow-800",children:[t.jsx(se,{className:"w-5 h-5"}),t.jsx("h3",{className:"font-medium",children:"Reactivation Locked"})]}),t.jsxs("p",{className:"text-sm text-yellow-700",children:["Your account reactivation is currently locked. Please try again in ",c.hours," hours."]})]}),o&&t.jsxs("div",{className:"p-4 bg-green-50 border border-green-200 rounded-lg space-y-3",children:[t.jsxs("div",{className:"flex items-center space-x-2 text-green-800",children:[t.jsx($,{className:"w-5 h-5"}),t.jsx("h3",{className:"font-medium",children:"Account Deactivated"})]}),t.jsx("p",{className:"text-sm text-green-700",children:"Your account has been deactivated. A reactivation link has been sent to your email."}),t.jsxs("div",{className:"space-y-2 pt-2",children:[t.jsx("p",{className:"text-sm font-medium text-gray-700",children:"Didn't receive the email? Request a new reactivation link:"}),t.jsxs("div",{className:"flex space-x-2",children:[t.jsx("input",{type:"email",value:x,onChange:u=>R(u.target.value),placeholder:"Your email",className:"flex-1 h-10 px-3 border rounded-lg text-sm"}),t.jsxs("button",{onClick:v,disabled:n,className:"h-10 px-4 bg-green-700 text-white rounded-lg font-medium hover:bg-green-800 transition-colors disabled:opacity-50 disabled:cursor-not-allowed text-sm flex items-center",children:[t.jsx(le,{className:"w-4 h-4 mr-2"}),"Send"]})]})]})]}),t.jsx("div",{className:"pt-4",children:t.jsx(G,{to:"/login",className:"w-full h-10 flex items-center justify-center bg-gray-200 text-gray-800 rounded-lg font-medium hover:bg-gray-300 transition-colors text-sm",children:"Back to Login"})})]}),!h&&t.jsx(t.Fragment,{children:t.jsx(re,{initialValues:d,validationSchema:a,onSubmit:A,children:({isSubmitting:u,touched:f,errors:p})=>t.jsxs(oe,{className:"space-y-4",children:[t.jsxs("div",{className:"space-y-1",children:[t.jsxs("div",{className:"relative flex items-center",children:[t.jsx(ae,{className:"absolute left-3 w-4 h-4 text-gray-400"}),t.jsx(T,{type:"email",name:"email",className:`w-full h-10 pl-9 pr-3 border rounded-lg text-sm ${f.email&&p.email?"border-red-500":"border-gray-300"}`,placeholder:"Email"})]}),t.jsx(U,{name:"email",component:"div",className:"text-xs text-red-500"})]}),t.jsxs("div",{className:"space-y-1",children:[t.jsxs("div",{className:"relative flex items-center",children:[t.jsx(ne,{className:"absolute left-3 w-4 h-4 text-gray-400"}),t.jsx(T,{type:"password",name:"password",className:`w-full h-10 pl-9 pr-3 border rounded-lg text-sm ${f.password&&p.password?"border-red-500":"border-gray-300"}`,placeholder:"Password"})]}),t.jsx(U,{name:"password",component:"div",className:"text-xs text-red-500"})]}),t.jsx("div",{className:"text-right",children:t.jsx(G,{to:"/forgot-password",className:"text-xs text-green-700 hover:underline",children:"Forgot password?"})}),t.jsx("button",{type:"submit",disabled:u||n,className:"w-full h-10 bg-green-700 text-white rounded-lg font-medium hover:bg-green-800 transition-colors disabled:opacity-50 disabled:cursor-not-allowed text-sm",children:u||n?"Logging in...":"Login"}),t.jsxs("div",{className:"relative py-2",children:[t.jsx("div",{className:"absolute inset-0 flex items-center",children:t.jsx("div",{className:"w-full border-t border-gray-300"})}),t.jsx("div",{className:"relative flex justify-center",children:t.jsx("span",{className:"px-4 text-xs text-gray-500 bg-white",children:"Or continue with"})})]}),t.jsxs("button",{type:"button",onClick:N,disabled:n,className:"w-full h-10 flex items-center justify-center gap-2 border border-gray-300 rounded-lg text-gray-700 font-medium hover:bg-gray-50 transition-colors disabled:opacity-50 disabled:cursor-not-allowed text-sm",children:[t.jsx("img",{src:"/google.svg",alt:"Google",className:"w-4 h-4"}),t.jsx("span",{children:"Sign in with Google"})]}),S&&t.jsxs("div",{className:"mt-4 p-4 bg-blue-50 border border-blue-200 rounded-lg space-y-3",children:[t.jsxs("div",{className:"flex items-center space-x-2 text-blue-800",children:[t.jsx($,{className:"w-5 h-5"}),t.jsx("h3",{className:"font-medium",children:"Popup Blocked"})]}),t.jsx("p",{className:"text-sm text-blue-700",children:"Your browser blocked the sign-in popup. You can enable popups in your browser settings or use the redirect method instead."}),t.jsxs("button",{type:"button",onClick:k,disabled:n,className:"w-full h-10 flex items-center justify-center gap-2 bg-blue-700 text-white rounded-lg font-medium hover:bg-blue-800 transition-colors disabled:opacity-50 disabled:cursor-not-allowed text-sm",children:[t.jsx("img",{src:"/google.svg",alt:"Google",className:"w-4 h-4 invert"}),t.jsx("span",{children:"Sign in with Google (Redirect)"})]})]}),g&&t.jsx("div",{className:"p-3 bg-red-50 border border-red-200 rounded-lg text-sm text-red-700",children:g}),t.jsxs("div",{className:"text-center text-xs text-gray-600",children:["Not a member?"," ",t.jsx(G,{to:"/register",className:"font-medium text-green-700 hover:underline",children:"Sign up now"})]})]})})})]})]})]})]})};export{pe as default};
