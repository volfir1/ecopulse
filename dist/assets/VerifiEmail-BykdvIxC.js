import{d as R,b as W,m as B,e as F,u as L,r as i,j as e,B as N,T as g,a as h,n as A}from"./index-CeiZKB8G.js";import{T as D}from"./TextField-CJViWXc3.js";import"./Select-CMa9xVQT.js";const G=()=>{const k=R(),v=W(),[x]=B(),r=F(),{verifyEmail:T,resendVerificationCode:j,isLoading:M}=L(),[n,I]=i.useState(""),[c,p]=i.useState(!1),[s,y]=i.useState(60),[d,S]=i.useState(0),m=k.state||{},V=x.get("userId"),E=x.get("email"),l=m.userId||V||"",f=m.email||E||"",C=m.provider||"email";i.useEffect(()=>{let a;return s>0&&(a=setTimeout(()=>y(u=>u-1),1e3)),()=>clearTimeout(a)},[s]);const w=async a=>{var u;if(a&&a.preventDefault(),!n){r.error("Please enter a verification code");return}p(!0);try{console.log("Verification attempt:",{userId:l,email:f,verificationCode:n,attempts:d+1}),S(o=>o+1);const t=await T(l,n);if(t!=null&&t.success){const o=localStorage.getItem("authToken"),b=localStorage.getItem("user");console.log("Pre-navigation check:",{hasToken:o,hasUser:b}),!o&&((u=t.user)!=null&&u.accessToken)&&(localStorage.setItem("authToken",t.user.accessToken),console.log("Saved token in component as fallback")),!b&&t.user&&(localStorage.setItem("user",JSON.stringify(t.user)),console.log("Saved user in component as fallback")),r.success("Email verified successfully!"),setTimeout(()=>{(!localStorage.getItem("authToken")||!localStorage.getItem("user"))&&console.warn("Still missing auth data before navigation!"),console.log("Redirecting to onboarding page..."),v("/onboarding",{replace:!0,state:{verified:!0,email:f,userId:l,message:"Email verified successfully! Complete your profile to get started."}})},2e3)}else throw new Error("Verification failed")}catch(t){console.error("Verification error:",t);const o=t.message||"Verification failed";o.includes("Invalid verification code")?r.error("Invalid verification code. Please check and try again."):r.error(o)}finally{p(!1)}},P=async()=>{try{await j(l),y(60),S(0),r.success("New verification code sent!")}catch(a){r.error(a.message||"Failed to resend code")}};return e.jsxs(N,{sx:{maxWidth:400,mx:"auto",mt:8,p:3},children:[e.jsx(g,{variant:"h4",gutterBottom:!0,children:"Verify Your Email"}),e.jsx(g,{variant:"body1",sx:{mb:3},children:C==="google"?"Please enter the verification code sent to your Google email":"Please enter the verification code sent to your email"}),e.jsxs(g,{variant:"body2",color:"textSecondary",sx:{mb:2},children:["Email: ",f||"your email"]}),!1,e.jsxs("form",{onSubmit:w,noValidate:!0,children:[e.jsx(D,{fullWidth:!0,label:"Verification Code",value:n,onChange:a=>I(a.target.value),margin:"normal",required:!0,error:d>1,helperText:d>1?"Multiple incorrect attempts":""}),e.jsx(h,{fullWidth:!0,variant:"contained",type:"submit",sx:{mt:3},disabled:c,children:c?e.jsxs(e.Fragment,{children:[e.jsx(A,{size:24,sx:{mr:1,color:"white"}}),"Verifying..."]}):"Verify Email"}),e.jsx(h,{fullWidth:!0,variant:"text",onClick:P,disabled:s>0||c,sx:{mt:2},children:s>0?`Resend code in ${s}s`:"Resend verification code"}),e.jsx(h,{fullWidth:!0,variant:"text",onClick:()=>v("/login"),sx:{mt:1},disabled:c,children:"Return to Login"})]})]})};export{G as default};
